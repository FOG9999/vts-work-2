CREATE OR REPLACE
PACKAGE BODY "PKG_KIENNGHI_CUTRI" AS
PROCEDURE PRC_COQUAN_LINHVUC(res out sys_refcursor) AS
  BEGIN
    Open res for     
    SELECT QUOCHOI_COQUAN.CTEN AS TENCOQUAN,QUOCHOI_COQUAN.ICOQUAN AS ID_COQUAN,
  QUOCHOI_COQUAN.IPARENT AS ID_PARENT_COQUAN,QUOCHOI_COQUAN0.CTEN AS TEN_PARENT_COQUAN,
  QUOCHOI_COQUAN.CCODE AS MA_COQUAN,LINHVUC_COQUAN.CTEN AS TENLINHVUC,LINHVUC_COQUAN.CCODE AS MA_LINHVUC, 
  LINHVUC_COQUAN.ILINHVUC AS ID_LINHVUC
  FROM QUOCHOI_COQUAN 
      LEFT JOIN QUOCHOI_COQUAN QUOCHOI_COQUAN0 ON QUOCHOI_COQUAN0.ICOQUAN=QUOCHOI_COQUAN.IPARENT
      LEFT JOIN LINHVUC_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=LINHVUC_COQUAN.ICOQUAN AND LINHVUC_COQUAN.IDELETE=0 AND LINHVUC_COQUAN.IHIENTHI=1
  WHERE QUOCHOI_COQUAN.IDELETE=0 AND QUOCHOI_COQUAN.IHIENTHI=1 AND QUOCHOI_COQUAN.IPARENT!=0  
  ORDER BY QUOCHOI_COQUAN0.IVITRI,QUOCHOI_COQUAN.IVITRI,LINHVUC_COQUAN.IVITRI;
  END PRC_COQUAN_LINHVUC;

PROCEDURE PRC_CHUONGTRINH_TXCT_EXPORT(res out sys_refcursor,p_IKYHOP in NUMBER) AS
  BEGIN
    Open res for     
    SELECT QUOCHOI_COQUAN.CCODE AS MA_COQUAN,QUOCHOI_COQUAN.CTEN AS TEN_COQUAN,
      KN_CHUONGTRINH.ICHUONGTRINH AS ID_CHUONGTRINH,
      KN_CHUONGTRINH.CKEHOACH AS KEHOACH_SO,KN_CHUONGTRINH.CNOIDUNG AS NOIDUNG,
      QUOCHOI_KYHOP.CTEN AS KYHOP,KN_CHUONGTRINH.ITRUOCKYHOP AS TRUOCKYHOP,
      KN_CHUONGTRINH.DBATDAU AS NGAYBATDAU,KN_CHUONGTRINH.DKETTHUC AS NGAYKETTHUC
    --FROM KN_CHUONGTRINH
    --  LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_CHUONGTRINH.IDONVI
    --  LEFT JOIN QUOCHOI_KYHOP ON QUOCHOI_KYHOP.IKYHOP=KN_CHUONGTRINH.IKYHOP
    FROM QUOCHOI_COQUAN 
      LEFT JOIN KN_CHUONGTRINH ON QUOCHOI_COQUAN.ICOQUAN=KN_CHUONGTRINH.IDONVI
      LEFT JOIN QUOCHOI_KYHOP ON QUOCHOI_KYHOP.IKYHOP=KN_CHUONGTRINH.IKYHOP
      WHERE QUOCHOI_COQUAN.IPARENT=20 AND KN_CHUONGTRINH.IKYHOP=p_IKYHOP
      ORDER BY QUOCHOI_COQUAN.CTEN;
  END PRC_CHUONGTRINH_TXCT_EXPORT;

    PROCEDURE PRC_TAPHOP_IMPORT(res out sys_refcursor,p_ID_IMPORT in NUMBER) AS
    BEGIN
      Open res for     
      SELECT KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI,KN_TONGHOP.CNOIDUNG AS NOIDUNG_TONGHOP,
        KN_TONGHOP.ITONGHOP AS ID_TONGHOP,QUOCHOI_COQUAN.CTEN AS TENDONVI_THAMQUYEN
      FROM KN_TONGHOP LEFT JOIN KN_KIENNGHI ON KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP
      LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
      WHERE KN_TONGHOP.ID_IMPORT=p_ID_IMPORT
      ORDER BY KN_TONGHOP.ITONGHOP;
  END PRC_TAPHOP_IMPORT;

  /*
  PROCEDURE PRC_INSERT_IMPORT_TMP(p_NOIDUNG in NVARCHAR2,p_DIAPHUONG in NVARCHAR2,p_DONVI_THAMQUYEN in NVARCHAR2,
                                                  p_LINHVUC in NVARCHAR2,p_KEHOACH in NVARCHAR2,p_KYHOP in NVARCHAR2,
                                                  p_HINHTHUC in NVARCHAR2,p_CONGVAN in NVARCHAR2,p_SOCONGVAN in NVARCHAR2,
                                                  p_NGAYBANHANH in DATE,p_ID_IMPORT in NUMBER) AS
    BEGIN 
     INSERT INTO KN_IMPORT_TMP(NOIDUNG,DIAPHUONG,DONVI_THAMQUYEN,LINHVUC,KEHOACH,KYHOP,HINHTHUC,CONGVAN,SOCONGVAN,NGAYBANHANH,ID_IMPORT) VALUES
     (p_NOIDUNG,p_DIAPHUONG,p_DONVI_THAMQUYEN,p_LINHVUC,p_KEHOACH,p_KYHOP,p_HINHTHUC,p_CONGVAN,p_SOCONGVAN,p_NGAYBANHANH,p_ID_IMPORT);

  END PRC_INSERT_IMPORT_TMP;
  */
  PROCEDURE PRC_HUY_KIENNGHI_IMPORT(p_ID_IMPORT in NUMBER) AS
    BEGIN 
      DELETE FROM KN_GIAMSAT WHERE KN_GIAMSAT.IKIENNGHI IN (SELECT KN_KIENNGHI.IKIENNGHI FROM KN_KIENNGHI WHERE KN_KIENNGHI.ID_IMPORT=p_ID_IMPORT);
      DELETE FROM KN_KIENNGHI_TRALOI WHERE KN_KIENNGHI_TRALOI.IKIENNGHI IN (SELECT KN_KIENNGHI.IKIENNGHI FROM KN_KIENNGHI WHERE KN_KIENNGHI.ID_IMPORT=p_ID_IMPORT);
      DELETE FROM KN_VANBAN WHERE KN_VANBAN.ITONGHOP IN (SELECT KN_TONGHOP.ITONGHOP FROM KN_TONGHOP WHERE KN_TONGHOP.ID_IMPORT=p_ID_IMPORT);
      DELETE FROM KN_TONGHOP WHERE ID_IMPORT=p_ID_IMPORT;
      DELETE FROM KN_KIENNGHI WHERE ID_IMPORT=p_ID_IMPORT;
  END PRC_HUY_KIENNGHI_IMPORT;

  PROCEDURE PRC_KIENNGHI_IMPORT(res out sys_refcursor,p_ID_IMPORT in NUMBER) AS
    BEGIN
      Open res for     
      SELECT KN_KIENNGHI_IMPORT.*,QUOCHOI_COQUAN.CTEN AS TENDONVI_TIEPNHAN,THAMQUYEN.CTEN AS TENDONVI_THAMQUYEN,
      QUOCHOI_KYHOP.CTEN AS TEN_KYHOP,QUOCHOI_KHOA.CTEN AS TEN_KHOAHOP
      FROM KN_KIENNGHI_IMPORT 
        LEFT JOIN QUOCHOI_COQUAN ON KN_KIENNGHI_IMPORT.IDONVITIEPNHAN=QUOCHOI_COQUAN.ICOQUAN
        LEFT JOIN QUOCHOI_COQUAN THAMQUYEN ON KN_KIENNGHI_IMPORT.IDONVITHAMQUYEN=THAMQUYEN.ICOQUAN
        LEFT JOIN QUOCHOI_KYHOP ON QUOCHOI_KYHOP.IKYHOP=KN_KIENNGHI_IMPORT.IKYHOP
        LEFT JOIN QUOCHOI_KHOA ON QUOCHOI_KHOA.IKHOA=QUOCHOI_KYHOP.IKHOA
      WHERE KN_KIENNGHI_IMPORT.ID_IMPORT=p_ID_IMPORT
      ORDER BY QUOCHOI_COQUAN.ICOQUAN;
  END PRC_KIENNGHI_IMPORT;


PROCEDURE PRC_DOANGIAMSAT(res out sys_refcursor, p_IUSER IN NUMBER, p_CNOIDUNG IN NVARCHAR2, /* DEFAULT: */
                                                  p_IDDONVI IN NUMBER,
                                                  p_PAGE IN NUMBER,/* DEFAULT: */
                                                  p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                               ) AS
  BEGIN
    Open res for     
    WITH TONG_KIENNGHI AS (
        SELECT COUNT(*) AS TONG_KIENNGHI,KN_DOANGIAMSAT_KIENNGHI.IDOANGIAMSAT FROM KN_DOANGIAMSAT_KIENNGHI 
        INNER JOIN KN_DOANGIAMSAT ON KN_DOANGIAMSAT.IDOAN=KN_DOANGIAMSAT_KIENNGHI.IDOANGIAMSAT
        WHERE  1=1 
        and (p_IUSER = 0 or KN_DOANGIAMSAT.IUSER = p_IUSER )
        and (UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%' OR UPPER(KN_DOANGIAMSAT.CTEN) LIKE '%' || UPPER(p_CNOIDUNG) || '%')
        AND (p_IDDONVI=0 OR KN_DOANGIAMSAT.IDONVI=p_IDDONVI)
        GROUP BY KN_DOANGIAMSAT_KIENNGHI.IDOANGIAMSAT
    ),
    TBL4 AS (SELECT IDOAN,IUSER AS ID_USER_CAPNHAT,KN_DOANGIAMSAT.CTEN AS TEN_KEHOACH,CNOIDUNG AS NOIDUNG_GIAMSAT,
             DNGAYBATDAU AS NGAYBATDAU,IDONVI AS ID_DONVI,QUOCHOI_COQUAN.CTEN AS TEN_DONVI,
             COALESCE(TONG_KIENNGHI.TONG_KIENNGHI,0) AS SOKIENNGHI
              FROM KN_DOANGIAMSAT LEFT JOIN TONG_KIENNGHI ON TONG_KIENNGHI.IDOANGIAMSAT=KN_DOANGIAMSAT.IDOAN
              LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_DOANGIAMSAT.IDONVI
              WHERE 1=1 
              and (p_IUSER = 0 or KN_DOANGIAMSAT.IUSER = p_IUSER )
              AND (UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%' OR UPPER(KN_DOANGIAMSAT.CTEN) LIKE '%' || UPPER(p_CNOIDUNG) || '%')
              AND (p_IDDONVI=0 OR KN_DOANGIAMSAT.IDONVI=p_IDDONVI)
              ORDER BY KN_DOANGIAMSAT.IDONVI,KN_DOANGIAMSAT.DNGAYBATDAU
    )    
    SELECT * FROM 
        ( SELECT k.*,(SELECT COUNT(*) FROM TBL4) AS TOTAL, ROWNUM r_ FROM( select * from TBL4 ) k WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 ) ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
  END PRC_DOANGIAMSAT;
-- KIEM TRUNG
  PROCEDURE PRC_KIENNGHI_TRUNG(res out sys_refcursor,  p_CNOIDUNG1 IN NVARCHAR2, /* DEFAULT: */
                                                     p_CNOIDUNG2 IN NVARCHAR2, /* DEFAULT: */
                                                     p_CNOIDUNG3 IN NVARCHAR2, /* DEFAULT: */
                                                     p_CNOIDUNG4 IN NVARCHAR2, /* DEFAULT: */
                                                     p_CNOIDUNG5 IN NVARCHAR2 /* DEFAULT: */

                                                               ) AS
  BEGIN
    Open res for
        WITH TRUNG1 AS(
            SELECT IKIENNGHI AS ID_KIENNGHI FROM KN_KIENNGHI WHERE UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG1) || '%' 
               AND p_CNOIDUNG1 is not null AND IKIEMTRATRUNG=0 AND IKIENNGHI_TRUNG=0 AND ID_GOP<=0
              ),
            TRUNG2 AS(
            SELECT IKIENNGHI AS ID_KIENNGHI FROM KN_KIENNGHI WHERE UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG2) || '%' 
               AND p_CNOIDUNG2 is not null AND IKIEMTRATRUNG=0 AND IKIENNGHI_TRUNG=0 AND ID_GOP<=0
              ),
            TRUNG3 AS(
            SELECT IKIENNGHI AS ID_KIENNGHI FROM KN_KIENNGHI WHERE UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG3) || '%' 
               AND p_CNOIDUNG3 is not null AND IKIEMTRATRUNG=0 AND IKIENNGHI_TRUNG=0 AND ID_GOP<=0
              ),
            TRUNG4 AS(
            SELECT IKIENNGHI AS ID_KIENNGHI FROM KN_KIENNGHI WHERE UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG4) || '%' 
               AND p_CNOIDUNG4 is not null AND IKIEMTRATRUNG=0 AND IKIENNGHI_TRUNG=0 AND ID_GOP<=0
              ),
            TRUNG5 AS(
            SELECT IKIENNGHI AS ID_KIENNGHI FROM KN_KIENNGHI WHERE UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG5) || '%' 
               AND p_CNOIDUNG5 is not null AND IKIEMTRATRUNG=0 AND IKIENNGHI_TRUNG=0 AND ID_GOP<=0
              ),
            TBL4 AS (SELECT * FROM TRUNG1 UNION SELECT * FROM TRUNG2 UNION SELECT * FROM TRUNG3
                      UNION SELECT * FROM TRUNG4 UNION SELECT * FROM TRUNG5),
            TBL5 AS (SELECT TBL4.ID_KIENNGHI,CNOIDUNG AS NOIDUNG_KIENNGHI,KN_KIENNGHI.IKYHOP AS ID_KYHOP_TIEPNHAN,
                  QUOCHOI_KYHOP.CTEN AS TEN_KYHOP_TIEPNHAN,
                  QUOCHOI_KYHOP.IKHOA AS ID_KHOAHOP,
                  IDONVITIEPNHAN AS ID_DONVITIEPNHAN,COQUANTIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,
                  ITHAMQUYENDONVI AS ID_THAMQUYENDONVI,COQUANTHAMQUYEN.CTEN AS TEN_DONVITHAMQUYEN,
                  QUOCHOI_KHOA.CTEN AS TEN_KHOAHOP
            FROM KN_KIENNGHI INNER JOIN TBL4 ON TBL4.ID_KIENNGHI=KN_KIENNGHI.IKIENNGHI
            LEFT JOIN QUOCHOI_KYHOP ON QUOCHOI_KYHOP.IKYHOP=KN_KIENNGHI.IKYHOP
            LEFT JOIN QUOCHOI_KHOA ON QUOCHOI_KYHOP.IKHOA=QUOCHOI_KHOA.IKHOA
            LEFT JOIN QUOCHOI_COQUAN COQUANTIEPNHAN ON COQUANTIEPNHAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
            LEFT JOIN QUOCHOI_COQUAN COQUANTHAMQUYEN ON COQUANTHAMQUYEN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
            WHERE ITHAMQUYENDONVI!=0)
            SELECT TBL5.* FROM TBL5;

  END PRC_KIENNGHI_TRUNG;

   PROCEDURE PRC_LIST_USER_CAPNHAT(res out sys_refcursor,  p_ID_DONVI IN NUMBER) AS
  BEGIN
    Open res for
        WITH CAPNHAT AS (SELECT KN_KIENNGHI.IUSER AS ID_USER FROM KN_KIENNGHI 
        LEFT JOIN USERS ON KN_KIENNGHI.IUSER=USERS.IUSER WHERE USERS.IDONVI=p_ID_DONVI GROUP BY KN_KIENNGHI.IUSER
        )
        SELECT USERS.CTEN AS USER_CAPNHAT,USERS.IUSER AS USER_ID
        FROM USERS INNER JOIN CAPNHAT ON CAPNHAT.ID_USER=USERS.IUSER
        ORDER BY USERS.CTEN;    
  END PRC_LIST_USER_CAPNHAT;

  PROCEDURE PRC_KIENNGHI_DELETE(res out sys_refcursor,  p_ID_USER IN NUMBER) AS
  BEGIN
    Open res for
        SELECT KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI,
    KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI,
    DONVI_TIEPNHAN.CTEN AS TEN_DONVI_TIEPNHAN,
    DONVI_THAMQUYEN.CTEN AS TEN_DONVI_THAMQUYEN
    FROM KN_KIENNGHI 
    LEFT JOIN QUOCHOI_COQUAN DONVI_TIEPNHAN ON DONVI_TIEPNHAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
    LEFT JOIN QUOCHOI_COQUAN DONVI_THAMQUYEN ON DONVI_THAMQUYEN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
    WHERE KN_KIENNGHI.IDELETE=1 AND (KN_KIENNGHI.IUSER=p_ID_USER OR p_ID_USER=0);

  END PRC_KIENNGHI_DELETE;
  /*
  PROCEDURE PRC_PHANTRANG_KIENNGHI_TRACUU(res out sys_refcursor, p_ITINHTRANG in NUMBER, -- DEFAULT: -1
                                                               p_ILINHVUC IN NUMBER, -- DEFAULT: -1
                                                               p_IDONVITIEPNHAN in NUMBER, -- DEFAULT: 0
                                                               p_IKYHOP in NUMBER, -- DEFAULT: 0
                                                               p_ITRUOCKYHOP IN NUMBER, -- DEFAULT: -1
                                                               p_ITHAMQUYENDONVI in NUMBER,-- DEFAULT: 0
                                                               p_CNOIDUNG IN NVARCHAR2 -- DEFAULT: 
                                                               ) AS
  BEGIN
    Open res for
    SELECT  ROW_NUMBER() OVER(ORDER BY KN_KIENNGHI.ITHAMQUYENDONVI,KN_KIENNGHI.ILINHVUC) ROW_NUM,
              KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI,
              KN_KIENNGHI.IUSER AS ID_USER_CAPNHAT,IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG,
              KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN,
              KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,COQUAN_TIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI,
              KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,LINHVUC_COQUAN.CTEN AS TEN_LINHVUC,
              KN_KIENNGHI.ITINHTRANG,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI INNER JOIN QUOCHOI_COQUAN COQUAN_TIEPNHAN ON COQUAN_TIEPNHAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
                        INNER JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON COQUAN_THAMQUYEN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
                        LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      WHERE 
      (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND 
      (p_ITINHTRANG=-1 OR KN_KIENNGHI.ITINHTRANG=p_ITINHTRANG) AND 
      (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC=p_ILINHVUC) AND 
      (p_IDONVITIEPNHAN=0 OR KN_KIENNGHI.IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
      (p_ITRUOCKYHOP=-1 OR KN_KIENNGHI.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
      (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) 
      AND KN_KIENNGHI.ITHAMQUYENDONVI!=0
      AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%';
  END PRC_PHANTRANG_KIENNGHI_TRACUU;
  */
  /*
  PROCEDURE PRC_TONGHOP_CHUYEN_BDN(res out sys_refcursor,  p_ILINHVUC IN NUMBER, -- DEFAULT: -1
                                                               p_IDONVITONGHOP in NUMBER, -- DEFAULT: 0
                                                               p_IKYHOP in NUMBER, -- DEFAULT: 0
                                                               p_ITRUOCKYHOP IN NUMBER, -- DEFAULT: -1
                                                               p_ITHAMQUYENDONVI in NUMBER,-- DEFAULT: -1
                                                               p_CNOIDUNG IN NVARCHAR2 -- DEFAULT:                                                              
                                                               ) AS
  BEGIN
    Open res for
    WITH TBL1 AS(
        SELECT  KN_TONGHOP.ITONGHOP,KN_TONGHOP.IUSER AS IUSER_CAPNHAT,
                (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_TONGHOP.IDONVITONGHOP) AS TEN_DONVITONGHOP,
                (SELECT ICOQUAN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_TONGHOP.IDONVITONGHOP) AS ID_DONVITONGHOP,
                (SELECT ICOQUAN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_TONGHOP.ITHAMQUYENDONVI) AS ID_THAMQUYEN_DONVI_TONGHOP,
                (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_TONGHOP.ITHAMQUYENDONVI) AS TEN_THAMQUYEN_DONVI_TONGHOP,
                (SELECT CTEN FROM LINHVUC_COQUAN WHERE ILINHVUC=KN_TONGHOP.ILINHVUC) AS TEN_LINHVUC_TONGHOP,
                 KN_TONGHOP.CNOIDUNG AS NOIDUNG_TONGHOP, 
                 (SELECT COUNT(*) FROM KN_KIENNGHI WHERE ITONGHOP=KN_TONGHOP.ITONGHOP OR ITONGHOP_BDN=KN_TONGHOP.ITONGHOP) AS SOKIENNGHI_TONGHOP
        FROM KN_TONGHOP 
        WHERE (p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP) AND 
              KN_TONGHOP.ITINHTRANG=2 AND 
              (p_ILINHVUC=-1 OR KN_TONGHOP.ILINHVUC=p_ILINHVUC) AND 
              (p_IDONVITONGHOP=0 OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) AND 
              (p_ITRUOCKYHOP=-1 OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
              (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND 
              KN_TONGHOP.ITHAMQUYENDONVI!=0 AND
              KN_TONGHOP.CNOIDUNG LIKE '%' || p_CNOIDUNG || '%'),
    TBL2 AS(
        SELECT  KN_KIENNGHI.IKIENNGHI,KN_KIENNGHI.ID_GOP,KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,
                KN_KIENNGHI.ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN,KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,            
                (SELECT ICOQUAN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS ID_THAMQUYEN_DONVI_KIENNGHI,
                (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS TEN_THAMQUYEN_DONVI_KIENNGHI,
                (SELECT CTEN FROM LINHVUC_COQUAN WHERE ILINHVUC=KN_KIENNGHI.ILINHVUC) AS TEN_LINHVUC_KIENNGHI,
                KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI           
        FROM KN_KIENNGHI INNER JOIN KN_TONGHOP ON KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP OR KN_KIENNGHI.ITONGHOP_BDN=KN_TONGHOP.ITONGHOP
        WHERE ID_GOP<=0 AND (p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP) AND 
              KN_TONGHOP.ITINHTRANG=2 AND 
              (p_ILINHVUC=-1 OR KN_TONGHOP.ILINHVUC=p_ILINHVUC) AND 
              (p_IDONVITONGHOP=0 OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) AND 
              (p_ITRUOCKYHOP=-1 OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
              (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND 
              KN_TONGHOP.ITHAMQUYENDONVI!=0 AND
              UPPER(KN_TONGHOP.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
    ),
    TBL3 as(
        select 
        KN_KIENNGHI.IKIENNGHI AS IKIENNGHI_GOP,
        KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP,
           (SELECT CTEN FROM QUOCHOI_COQUAN WHERE QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TENDONVITIEPNHAN_GOP
        FROM KN_KIENNGHI 
        INNER JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
        LEFT JOIN DIAPHUONG ON DIAPHUONG.IDIAPHUONG=KN_KIENNGHI.IDIAPHUONG0 
        start with ID_GOP=-1
        CONNECT BY PRIOR IKIENNGHI=ID_GOP
        )
  SELECT * FROM TBL1 LEFT JOIN TBL2 ON TBL2.ID_KIENNGHI_TONGHOP=TBL1.ITONGHOP OR TBL2.ID_KIENNGHI_TONGHOP_BDN=TBL1.ITONGHOP
                        LEFT JOIN TBL3 ON TBL2.IKIENNGHI=TBL3.ID_KIENNGHI_PARENT_GOP;

  END PRC_TONGHOP_CHUYEN_BDN;
  */
  PROCEDURE PRC_TONGHOP_KIENNGHI(res out sys_refcursor,  p_ITINHTRANG in NUMBER, /* DEFAULT: -1*/
                                                               p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                               p_IDONVITONGHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,/* DEFAULT:0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2, /* DEFAULT: */
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                               ) AS
  BEGIN
    Open res for
  WITH 
  TONGKIENNGHI AS (SELECT COUNT(*) AS SOKIENNGHI_TONGHOP, KN_TONGHOP.ITONGHOP AS ID_TONGHOP FROM KN_TONGHOP 
                  INNER JOIN KN_KIENNGHI ON (KN_KIENNGHI.ITONGHOP_BDN=KN_TONGHOP.ITONGHOP OR KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP)
                  GROUP BY KN_TONGHOP.ITONGHOP),
  TBL1 AS(
        SELECT  KN_TONGHOP.ITONGHOP,KN_TONGHOP.ITINHTRANG,KN_TONGHOP.IUSER AS IUSER_CAPNHAT,
                KN_TONGHOP.DDATE AS NGAY_TONGHOP,KN_VANBAN.DNGAYBANHANH AS NGAY_CHUYENTONGHOP,                
                COQUAN_TONGHOP.CTEN AS TEN_DONVITONGHOP,KN_TONGHOP.IDONVITONGHOP AS ID_DONVITONGHOP,
                KN_TONGHOP.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI_TONGHOP,
                COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI_TONGHOP,
                LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_TONGHOP,
                KN_TONGHOP.ILINHVUC AS ID_LINHVUC_TONGHOP,
                COQUAN_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,
                KN_TONGHOP.CNOIDUNG AS NOIDUNG_TONGHOP, TONGKIENNGHI.SOKIENNGHI_TONGHOP AS SOKIENNGHI_TONGHOP
        FROM KN_TONGHOP 
        LEFT JOIN KN_VANBAN ON KN_VANBAN.ITONGHOP=KN_TONGHOP.ITONGHOP AND KN_VANBAN.CLOAI='tonghop_chuyenxuly'
        LEFT JOIN QUOCHOI_COQUAN COQUAN_TONGHOP ON COQUAN_TONGHOP.ICOQUAN=KN_TONGHOP.IDONVITONGHOP
        LEFT JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON COQUAN_THAMQUYEN.ICOQUAN=KN_TONGHOP.ITHAMQUYENDONVI
        LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_TONGHOP.ILINHVUC
        LEFT JOIN TONGKIENNGHI ON TONGKIENNGHI.ID_TONGHOP=KN_TONGHOP.ITONGHOP
        --INNER JOIN KN_KIENNGHI ON KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP OR KN_KIENNGHI.ITONGHOP_BDN=KN_TONGHOP.ITONGHOP
        WHERE 
              --KN_TONGHOP.IKYHOP=1 AND KN_TONGHOP.ITINHTRANG=2
            (p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP) AND 
            (p_ITHAMQUYENDONVI_PARENT=0 OR COQUAN_THAMQUYEN.IPARENT=p_ITHAMQUYENDONVI_PARENT) AND 
            (p_ITINHTRANG=-1 OR KN_TONGHOP.ITINHTRANG=p_ITINHTRANG) AND 
            (p_ILINHVUC=-1 OR KN_TONGHOP.ILINHVUC=p_ILINHVUC) AND 
            (p_IDONVITONGHOP=0 OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) AND 
            (p_ITRUOCKYHOP=-1 OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
            (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND 
            KN_TONGHOP.ITHAMQUYENDONVI!=0 AND
            UPPER(KN_TONGHOP.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'              
              ),
    TBL2 AS(
        SELECT  KN_KIENNGHI.IKIENNGHI,KN_KIENNGHI.ID_GOP,KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,
                KN_KIENNGHI.ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN,KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,         
                COQUAN_TONGHOP.CTEN AS TEN_DONVITIEPNHAN_KIENNGHI,
                KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI_KIENNGHI,
                COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI_KIENNGHI,
                LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_KIENNGHI,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI,
                KN_KIENNGHI.ILINHVUC as ID_LINHVUC_KIENNGHI
        FROM KN_TONGHOP 
        LEFT JOIN KN_KIENNGHI ON KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP OR KN_KIENNGHI.ITONGHOP_BDN=KN_TONGHOP.ITONGHOP
        LEFT JOIN QUOCHOI_COQUAN COQUAN_TONGHOP ON COQUAN_TONGHOP.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
        LEFT JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON COQUAN_THAMQUYEN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
        LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
        WHERE ID_GOP<=0 
              --AND KN_TONGHOP.IKYHOP=1 AND KN_TONGHOP.ITINHTRANG=2
              AND (p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP) AND 
              (p_ITHAMQUYENDONVI_PARENT=0 OR COQUAN_THAMQUYEN.IPARENT=p_ITHAMQUYENDONVI_PARENT) AND 
              (p_ITINHTRANG=-1 OR KN_TONGHOP.ITINHTRANG=p_ITINHTRANG) AND 
              (p_ILINHVUC=-1 OR KN_TONGHOP.ILINHVUC=p_ILINHVUC) AND 
              (p_IDONVITONGHOP=0 OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) AND 
              (p_ITRUOCKYHOP=-1 OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
              (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND 
              KN_TONGHOP.ITHAMQUYENDONVI!=0 AND
              UPPER(KN_TONGHOP.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
    ),
    KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.ID_GOP>0 AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) ORDER BY KN_KIENNGHI.ID_GOP),
    TBL3 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
        LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
        (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP             
        ),
    TBL4 AS (SELECT  TBL1.*,
    COALESCE(TBL2.IKIENNGHI,0) AS IKIENNGHI,COALESCE(TBL2.ID_GOP,0) AS ID_GOP,COALESCE(TBL2.ID_KIENNGHI_TONGHOP,0) AS ID_KIENNGHI_TONGHOP,
    COALESCE(TBL2.ID_KIENNGHI_TONGHOP_BDN,0) AS ID_KIENNGHI_TONGHOP_BDN,COALESCE(TBL2.ID_DONVITIEPNHAN,0) AS ID_DONVITIEPNHAN,
    TBL2.TEN_DONVITIEPNHAN_KIENNGHI,TBL2.ID_THAMQUYEN_DONVI_KIENNGHI,TBL2.TEN_THAMQUYEN_DONVI_KIENNGHI,TBL2.TEN_LINHVUC_KIENNGHI,
    TBL2.NOIDUNG_KIENNGHI,TBL3.*
    FROM TBL1 LEFT JOIN TBL2 ON TBL2.ID_KIENNGHI_TONGHOP=TBL1.ITONGHOP OR TBL2.ID_KIENNGHI_TONGHOP_BDN=TBL1.ITONGHOP
                        LEFT JOIN TBL3 ON TBL2.IKIENNGHI=TBL3.ID_KIENNGHI_PARENT_GOP
    ORDER BY TBL1.ID_THAMQUYEN_DONVI_TONGHOP,TBL1.ID_LINHVUC_TONGHOP,TBL1.ITONGHOP,TBL2.IKIENNGHI)
    SELECT * FROM 
        ( SELECT k.*,(SELECT COUNT(*) FROM TBL4) AS TOTAL, ROWNUM r_ FROM( select * from TBL4 ) k WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
                        --LEFT JOIN TBL4 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL4.ICOQUAN_PARENT_THAMQUYEN_DONVI
                        --WHERE (p_ITHAMQUYENDONVI_PARENT=0 OR TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT);
  END PRC_TONGHOP_KIENNGHI;

  --- l?y d? li?u cho module doan d?i bieu quoc hoi
  PROCEDURE PRC_TONGHOP_KIENNGHI_BDN(res out sys_refcursor,  p_ITINHTRANG in NUMBER, /* DEFAULT: -1*/   
                                                               p_LISTLINHVUC IN NVARCHAR2, /* DEFAULT: -1*/
                                                               p_IDONVITONGHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,/* DEFAULT:0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2, /* DEFAULT: */
                                                               p_LISTKYHOP IN NVARCHAR2,
                                                               p_LIST_HUYEN_XA_TP IN NVARCHAR2,
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER,
                                                               p_IUSER IN NUMBER
                                                               ) AS
  BEGIN
    Open res for
  WITH 
  TONGKIENNGHI AS (SELECT COUNT(*) AS SOKIENNGHI_TONGHOP, KN_TONGHOP.ITONGHOP AS ID_TONGHOP FROM KN_TONGHOP 
                  LEFT JOIN KN_KIENNGHI ON KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP
                  WHERE KN_KIENNGHI.ID_GOP<=0  AND (p_IUSER = 0 OR KN_KIENNGHI.IUSER = p_IUSER)
                  GROUP BY KN_TONGHOP.ITONGHOP),
  TBL1 AS(
        SELECT  KN_TONGHOP.ITONGHOP, KN_TONGHOP.IUSER AS IUSER_CAPNHAT,
                KN_TONGHOP.DDATE AS NGAY_TONGHOP,KN_VANBAN.DNGAYBANHANH AS NGAY_CHUYENTONGHOP,                
                COQUAN_TONGHOP.CTEN AS TEN_DONVITONGHOP,KN_TONGHOP.IDONVITONGHOP AS ID_DONVITONGHOP,
                KN_TONGHOP.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI_TONGHOP,
                COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI_TONGHOP,
                LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_TONGHOP,
                KN_TONGHOP.ILINHVUC AS ID_LINHVUC_TONGHOP,
                COQUAN_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,
                KN_TONGHOP.CNOIDUNG AS NOIDUNG_TONGHOP, TONGKIENNGHI.SOKIENNGHI_TONGHOP AS SOKIENNGHI_TONGHOP
        FROM KN_TONGHOP 
        LEFT JOIN KN_VANBAN ON KN_VANBAN.ITONGHOP=KN_TONGHOP.ITONGHOP AND KN_VANBAN.CLOAI='tonghop_chuyenxuly'
        LEFT JOIN QUOCHOI_COQUAN COQUAN_TONGHOP ON COQUAN_TONGHOP.ICOQUAN=KN_TONGHOP.IDONVITONGHOP
        LEFT JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON COQUAN_THAMQUYEN.ICOQUAN=KN_TONGHOP.ITHAMQUYENDONVI
        LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_TONGHOP.ILINHVUC
        LEFT JOIN TONGKIENNGHI ON TONGKIENNGHI.ID_TONGHOP=KN_TONGHOP.ITONGHOP
        --INNER JOIN KN_KIENNGHI ON KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP OR KN_KIENNGHI.ITONGHOP_BDN=KN_TONGHOP.ITONGHOP
        WHERE 
              --KN_TONGHOP.IKYHOP=1 AND KN_TONGHOP.ITINHTRANG=2
            --(p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP) AND 
            (p_ITHAMQUYENDONVI_PARENT=0 OR COQUAN_THAMQUYEN.IPARENT=p_ITHAMQUYENDONVI_PARENT) AND 
            (p_ITINHTRANG=-1 OR KN_TONGHOP.ITINHTRANG=p_ITINHTRANG) AND 
            (KN_TONGHOP.ILINHVUC IN (select regexp_substr(p_LISTLINHVUC,'[^,]+', 1, level)
					from dual
					connect BY regexp_substr(p_LISTLINHVUC, '[^,]+', 1, level)
					is not null) OR p_LISTLINHVUC = '' OR p_LISTLINHVUC is null) AND
            (p_IDONVITONGHOP=0 OR p_IDONVITONGHOP is null OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) AND 
            (p_ITRUOCKYHOP=-1 OR p_ITRUOCKYHOP is null OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
            (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND 
            KN_TONGHOP.ITHAMQUYENDONVI!=0 AND
            UPPER(KN_TONGHOP.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'              
              ),
    KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.ID_GOP>0 AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND (p_IUSER = 0 OR KN_KIENNGHI.IUSER = p_IUSER) ORDER BY KN_KIENNGHI.ID_GOP),
    TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
            LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
            (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP),
     KIENNGHI AS(
      SELECT COALESCE(KN_KIENNGHI.IKIENNGHI,0) AS IKIENNGHI,KN_KIENNGHI.ID_GOP,KN_KIENNGHI.ITONGHOP AS KIENNGHI_ID_TONGHOP,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI, KN_KIENNGHI.ITINHTRANG AS ITINHTRANG, KN_KIENNGHI.IKYHOP as IKYHOP,
      KN_KIENNGHI.IDIAPHUONG0 as IDIAPHUONG0,COALESCE(KN_KIENNGHI.ILINHVUC,0) AS ID_LINHVUC_KIENNGHI,
      LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_KIENNGHI,QUOCHOI_COQUAN.CTEN AS TEN_DONVITIEPNHAN_KIENNGHI,
      TBL2.TENDONVITIEPNHAN_GOP
      FROM KN_KIENNGHI LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      LEFT JOIN QUOCHOI_COQUAN ON KN_KIENNGHI.IDONVITIEPNHAN=QUOCHOI_COQUAN.ICOQUAN  
      LEFT JOIN TBL2 ON TBL2.ID_KIENNGHI_PARENT_GOP=KN_KIENNGHI.IKIENNGHI
      WHERE (p_IUSER = 0 OR KN_KIENNGHI.IUSER = p_IUSER) AND
      (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND KN_KIENNGHI.ID_GOP<=0
    ),
    TBL4 AS (SELECT  TBL1.*,KIENNGHI.*,TRACKING.CACTION AS THAMQUYEN_CHUYEN
    FROM TBL1 LEFT JOIN KIENNGHI ON TBL1.ITONGHOP=KIENNGHI.KIENNGHI_ID_TONGHOP
    LEFT JOIN TRACKING ON TRACKING.IKIENNGHI=KIENNGHI.IKIENNGHI AND TRACKING.ITONGHOP=TBL1.ITONGHOP
		LEFT JOIN QUOCHOI_COQUAN ON TBL1.ID_THAMQUYEN_DONVI_TONGHOP = QUOCHOI_COQUAN.ICOQUAN
		WHERE KIENNGHI.ITINHTRANG = 1 AND QUOCHOI_COQUAN.CTYPE = 'TW'
		AND (KIENNGHI.IKYHOP IN (select regexp_substr(p_LISTKYHOP,'[^,]+', 1, level)
					from dual
					connect BY regexp_substr(p_LISTKYHOP, '[^,]+', 1, level)
					is not null) OR p_LISTKYHOP = '0') 
        AND (KIENNGHI.IDIAPHUONG0 IN (select regexp_substr(p_LIST_HUYEN_XA_TP,'[^,]+', 1, level)
					from dual
					connect BY regexp_substr(p_LIST_HUYEN_XA_TP, '[^,]+', 1, level)
					is not null) OR p_LIST_HUYEN_XA_TP = '' OR p_LIST_HUYEN_XA_TP is null)
    ORDER BY TBL1.ID_THAMQUYEN_DONVI_TONGHOP,TBL1.ITONGHOP,KIENNGHI.ID_LINHVUC_KIENNGHI)
    --select * from kn_kiennghi;

    SELECT * FROM 
        ( SELECT k.*,(SELECT COUNT(*) FROM TBL4) AS TOTAL, ROWNUM r_ FROM( select * from TBL4 ) k WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
                        --LEFT JOIN TBL4 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL4.ICOQUAN_PARENT_THAMQUYEN_DONVI
                        --WHERE (p_ITHAMQUYENDONVI_PARENT=0 OR TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT);

  END PRC_TONGHOP_KIENNGHI_BDN;

	--------------------------------------------------------------------------------------
  --- l?y d? li?u cho module hoi dong nhan dan tinh
   PROCEDURE PRC_TONGHOP_KIENNGHI_HDNDTinh(res out sys_refcursor,  p_ITINHTRANG in NUMBER, /* DEFAULT: -1*/   
                                                               p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                               p_IDONVITONGHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,/* DEFAULT:0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2, /* DEFAULT: */
																															 p_LISTKYHOP IN NVARCHAR2,
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER,
                                                               p_IUSER IN NUMBER
                                                               ) AS
  BEGIN
    Open res for
  WITH 
  TONGKIENNGHI AS (SELECT COUNT(*) AS SOKIENNGHI_TONGHOP, KN_TONGHOP.ITONGHOP AS ID_TONGHOP FROM KN_TONGHOP 
                  INNER JOIN KN_KIENNGHI ON KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP
                  WHERE KN_KIENNGHI.ID_GOP<=0 AND (p_IUSER = 0 OR KN_KIENNGHI.IUSER = p_IUSER)
                  GROUP BY KN_TONGHOP.ITONGHOP),
  TBL1 AS(
        SELECT  KN_TONGHOP.ITONGHOP, KN_TONGHOP.IUSER AS IUSER_CAPNHAT,
                KN_TONGHOP.DDATE AS NGAY_TONGHOP,KN_VANBAN.DNGAYBANHANH AS NGAY_CHUYENTONGHOP,                
                COQUAN_TONGHOP.CTEN AS TEN_DONVITONGHOP,KN_TONGHOP.IDONVITONGHOP AS ID_DONVITONGHOP,
                KN_TONGHOP.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI_TONGHOP,
                COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI_TONGHOP,
                LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_TONGHOP,
                KN_TONGHOP.ILINHVUC AS ID_LINHVUC_TONGHOP,
                COQUAN_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,
                KN_TONGHOP.CNOIDUNG AS NOIDUNG_TONGHOP, TONGKIENNGHI.SOKIENNGHI_TONGHOP AS SOKIENNGHI_TONGHOP
        FROM KN_TONGHOP 
        LEFT JOIN KN_VANBAN ON KN_VANBAN.ITONGHOP=KN_TONGHOP.ITONGHOP AND KN_VANBAN.CLOAI='tonghop_chuyenxuly'
        LEFT JOIN QUOCHOI_COQUAN COQUAN_TONGHOP ON COQUAN_TONGHOP.ICOQUAN=KN_TONGHOP.IDONVITONGHOP
        LEFT JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON COQUAN_THAMQUYEN.ICOQUAN=KN_TONGHOP.ITHAMQUYENDONVI
        LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_TONGHOP.ILINHVUC
        LEFT JOIN TONGKIENNGHI ON TONGKIENNGHI.ID_TONGHOP=KN_TONGHOP.ITONGHOP
        --INNER JOIN KN_KIENNGHI ON KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP OR KN_KIENNGHI.ITONGHOP_BDN=KN_TONGHOP.ITONGHOP
        WHERE 
              --KN_TONGHOP.IKYHOP=1 AND KN_TONGHOP.ITINHTRANG=2
            --(p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP) AND 
            (p_ITHAMQUYENDONVI_PARENT=0 OR COQUAN_THAMQUYEN.IPARENT=p_ITHAMQUYENDONVI_PARENT) AND 
            (p_ITINHTRANG=-1 OR KN_TONGHOP.ITINHTRANG=p_ITINHTRANG) AND 
            (p_ILINHVUC=-1 OR KN_TONGHOP.ILINHVUC=p_ILINHVUC) AND 
            (p_IDONVITONGHOP=0 OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) AND 
            (p_ITRUOCKYHOP=-1 OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
            (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND 
            KN_TONGHOP.ITHAMQUYENDONVI!=0 AND
            UPPER(KN_TONGHOP.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'              
              ),
    KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.ID_GOP>0 AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND (p_IUSER = 0 OR KN_KIENNGHI.IUSER = p_IUSER) ORDER BY KN_KIENNGHI.ID_GOP),
    TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
            LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
            (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP),
     KIENNGHI AS(
      SELECT COALESCE(KN_KIENNGHI.IKIENNGHI,0) AS IKIENNGHI,KN_KIENNGHI.ID_GOP,KN_KIENNGHI.ITONGHOP AS KIENNGHI_ID_TONGHOP,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI, KN_KIENNGHI.ITINHTRANG AS ITINHTRANG, KN_KIENNGHI.IKYHOP as IKYHOP,
      COALESCE(KN_KIENNGHI.ILINHVUC,0) AS ID_LINHVUC_KIENNGHI,
      LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_KIENNGHI,QUOCHOI_COQUAN.CTEN AS TEN_DONVITIEPNHAN_KIENNGHI,
      TBL2.TENDONVITIEPNHAN_GOP
      FROM KN_KIENNGHI LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      LEFT JOIN QUOCHOI_COQUAN ON KN_KIENNGHI.IDONVITIEPNHAN=QUOCHOI_COQUAN.ICOQUAN  
      LEFT JOIN TBL2 ON TBL2.ID_KIENNGHI_PARENT_GOP=KN_KIENNGHI.IKIENNGHI
      WHERE 1=1 AND (p_IUSER = 0 OR KN_KIENNGHI.IUSER = p_IUSER) AND
      (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND KN_KIENNGHI.ID_GOP<=0
    ),
    TBL4 AS (SELECT  TBL1.*,KIENNGHI.*,TRACKING.CACTION AS THAMQUYEN_CHUYEN
    FROM TBL1 LEFT JOIN KIENNGHI ON TBL1.ITONGHOP=KIENNGHI.KIENNGHI_ID_TONGHOP
    LEFT JOIN TRACKING ON TRACKING.IKIENNGHI=KIENNGHI.IKIENNGHI AND TRACKING.ITONGHOP=TBL1.ITONGHOP
		LEFT JOIN QUOCHOI_COQUAN ON TBL1.ID_THAMQUYEN_DONVI_TONGHOP = QUOCHOI_COQUAN.ICOQUAN
		WHERE KIENNGHI.ITINHTRANG = 1 AND QUOCHOI_COQUAN.CTYPE = 'TINH'
		AND (KIENNGHI.IKYHOP IN (select regexp_substr(p_LISTKYHOP,'[^,]+', 1, level)
					from dual
					connect BY regexp_substr(p_LISTKYHOP, '[^,]+', 1, level)
					is not null) OR p_LISTKYHOP = '0')  
    ORDER BY TBL1.ID_THAMQUYEN_DONVI_TONGHOP,TBL1.ITONGHOP,KIENNGHI.ID_LINHVUC_KIENNGHI)
    --select * from kn_kiennghi;

    SELECT * FROM 
        ( SELECT k.*,(SELECT COUNT(*) FROM TBL4) AS TOTAL, ROWNUM r_ FROM( select * from TBL4 ) k WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
                        --LEFT JOIN TBL4 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL4.ICOQUAN_PARENT_THAMQUYEN_DONVI
                        --WHERE (p_ITHAMQUYENDONVI_PARENT=0 OR TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT);

  END PRC_TONGHOP_KIENNGHI_HDNDTinh;
	-----------------------------------------------------------------------------------------
	 --- l?y d? li?u cho module hoi dong nhan dan Huyen
   PROCEDURE PRC_TONGHOP_KIENNGHI_HUYEN(res out sys_refcursor,  p_ITINHTRANG in NUMBER, /* DEFAULT: -1*/ 
                                                               p_ILINHVUC IN NUMBER, /* DEFAULT: ''*/
--                                                               p_MAKIENNGHI IN NVARCHAR2, /* DEFAULT: ''*/
--                                                               p_LIST_HUYEN_TP IN NVARCHAR2, /* DEFAULT: ''*/
--                                                               p_DTUNGAY IN DATE, /* DEFAULT: date min*/
--                                                               p_DDENNGAY IN DATE, /* DEFAULT: date max*/
                                                               p_IDONVITONGHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,/* DEFAULT:0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2, /* DEFAULT: */
                                                               p_LISTKYHOP IN NVARCHAR2,
--                                                               p_iIDONVITIEPNHAN in NUMBER,/* DEFAULT: -1*/
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER,
                                                               p_IUSER IN NUMBER
                                                               ) AS
  BEGIN
    Open res for
  WITH 
  TONGKIENNGHI AS (SELECT COUNT(*) AS SOKIENNGHI_TONGHOP, KN_TONGHOP.ITONGHOP AS ID_TONGHOP FROM KN_TONGHOP 
                  INNER JOIN KN_KIENNGHI ON KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP
                  WHERE KN_KIENNGHI.ID_GOP<=0 AND (p_IUSER = 0 OR KN_KIENNGHI.IUSER = p_IUSER)
                  GROUP BY KN_TONGHOP.ITONGHOP),
  TBL1 AS(
        SELECT  KN_TONGHOP.ITONGHOP, KN_TONGHOP.IUSER AS IUSER_CAPNHAT,
                KN_TONGHOP.DDATE AS NGAY_TONGHOP,KN_VANBAN.DNGAYBANHANH AS NGAY_CHUYENTONGHOP,                
                COQUAN_TONGHOP.CTEN AS TEN_DONVITONGHOP,KN_TONGHOP.IDONVITONGHOP AS ID_DONVITONGHOP,
                KN_TONGHOP.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI_TONGHOP,
                COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI_TONGHOP,
                LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_TONGHOP,
                KN_TONGHOP.ILINHVUC AS ID_LINHVUC_TONGHOP,
                COQUAN_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,
                KN_TONGHOP.CNOIDUNG AS NOIDUNG_TONGHOP, TONGKIENNGHI.SOKIENNGHI_TONGHOP AS SOKIENNGHI_TONGHOP
        FROM KN_TONGHOP 
        LEFT JOIN KN_VANBAN ON KN_VANBAN.ITONGHOP=KN_TONGHOP.ITONGHOP AND KN_VANBAN.CLOAI='tonghop_chuyenxuly'
        LEFT JOIN QUOCHOI_COQUAN COQUAN_TONGHOP ON COQUAN_TONGHOP.ICOQUAN=KN_TONGHOP.IDONVITONGHOP
        LEFT JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON COQUAN_THAMQUYEN.ICOQUAN=KN_TONGHOP.ITHAMQUYENDONVI
        LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_TONGHOP.ILINHVUC
        LEFT JOIN TONGKIENNGHI ON TONGKIENNGHI.ID_TONGHOP=KN_TONGHOP.ITONGHOP
        --INNER JOIN KN_KIENNGHI ON KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP OR KN_KIENNGHI.ITONGHOP_BDN=KN_TONGHOP.ITONGHOP
        WHERE 
              --KN_TONGHOP.IKYHOP=1 AND KN_TONGHOP.ITINHTRANG=2
            --(p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP) AND 
            (p_ITHAMQUYENDONVI_PARENT=0 OR COQUAN_THAMQUYEN.IPARENT=p_ITHAMQUYENDONVI_PARENT) AND 
            (p_ITINHTRANG=-1 OR KN_TONGHOP.ITINHTRANG=p_ITINHTRANG) AND 
            (p_ILINHVUC=-1 OR KN_TONGHOP.ILINHVUC=p_ILINHVUC) AND 
--            (KN_TONGHOP.ILINHVUC IN (select regexp_substr(p_LISTLINHVUC,'[^,]+', 1, level)
--					from dual
--					connect BY regexp_substr(p_LISTLINHVUC, '[^,]+', 1, level)
--					is not null) OR p_LISTLINHVUC = '' OR p_LISTLINHVUC is null)  AND
--            (p_IDONVITONGHOP=0 OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) AND 
            (p_ITRUOCKYHOP=-1 OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
            (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND 
            KN_TONGHOP.ITHAMQUYENDONVI!=0 AND
            UPPER(KN_TONGHOP.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'              
              ),
    KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.ID_GOP>0 AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND (p_IUSER = 0 OR KN_KIENNGHI.IUSER = p_IUSER) ORDER BY KN_KIENNGHI.ID_GOP),
    TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
            LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
            (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP),
     KIENNGHI AS(
      SELECT COALESCE(KN_KIENNGHI.IKIENNGHI,0) AS IKIENNGHI,KN_KIENNGHI.ID_GOP,KN_KIENNGHI.ITONGHOP AS KIENNGHI_ID_TONGHOP,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI, KN_KIENNGHI.ITINHTRANG AS ITINHTRANG, KN_KIENNGHI.IKYHOP,
      KN_KIENNGHI.DDATE as DDATE ,KN_KIENNGHI.IDONVITIEPNHAN , KN_KIENNGHI.CMAKIENNGHI as CMAKIENNGHI, KN_KIENNGHI.IDIAPHUONG0 as IDIAPHUONG0 ,COALESCE(KN_KIENNGHI.ILINHVUC,0) AS ID_LINHVUC_KIENNGHI,
      LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_KIENNGHI,QUOCHOI_COQUAN.CTEN AS TEN_DONVITIEPNHAN_KIENNGHI,
      TBL2.TENDONVITIEPNHAN_GOP
      FROM KN_KIENNGHI LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      LEFT JOIN QUOCHOI_COQUAN ON KN_KIENNGHI.IDONVITIEPNHAN=QUOCHOI_COQUAN.ICOQUAN  
      LEFT JOIN TBL2 ON TBL2.ID_KIENNGHI_PARENT_GOP=KN_KIENNGHI.IKIENNGHI
      WHERE 1=1 AND (p_IUSER = 0 OR KN_KIENNGHI.IUSER = p_IUSER) AND
      (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) AND KN_KIENNGHI.ID_GOP<=0
    ),
    TBL4 AS (SELECT  TBL1.*,KIENNGHI.*,TRACKING.CACTION AS THAMQUYEN_CHUYEN
    FROM TBL1 LEFT JOIN KIENNGHI ON TBL1.ITONGHOP=KIENNGHI.KIENNGHI_ID_TONGHOP
    LEFT JOIN TRACKING ON TRACKING.IKIENNGHI=KIENNGHI.IKIENNGHI AND TRACKING.ITONGHOP=TBL1.ITONGHOP
		LEFT JOIN QUOCHOI_COQUAN ON TBL1.ID_THAMQUYEN_DONVI_TONGHOP = QUOCHOI_COQUAN.ICOQUAN
		WHERE KIENNGHI.ITINHTRANG = 1 AND QUOCHOI_COQUAN.CTYPE = 'HUYEN' AND
		(KIENNGHI.IKYHOP IN (select regexp_substr(p_LISTKYHOP,'[^,]+', 1, level)
					from dual
					connect BY regexp_substr(p_LISTKYHOP, '[^,]+', 1, level)
					is not null) OR p_LISTKYHOP = '0')  
--        AND  (KIENNGHI.IDIAPHUONG0 IN (select regexp_substr(p_LIST_HUYEN_TP,'[^,]+', 1, level)
--					from dual
--					connect BY regexp_substr(p_LIST_HUYEN_TP, '[^,]+', 1, level)
--					is not null) OR p_LIST_HUYEN_TP = '' OR p_LIST_HUYEN_TP is null)      
--        AND (KIENNGHI.CMAKIENNGHI = p_MAKIENNGHI or p_MAKIENNGHI is null or p_MAKIENNGHI = '')
--        AND (p_DTUNGAY is null OR KIENNGHI.DDATE >= p_DTUNGAY)
--        AND (p_DDENNGAY is null OR KIENNGHI.DDATE <= p_DDENNGAY)
--        AND (p_iIDONVITIEPNHAN is null OR p_iIDONVITIEPNHAN = '' OR KIENNGHI.IDONVITIEPNHAN = p_iIDONVITIEPNHAN)

    ORDER BY TBL1.ID_THAMQUYEN_DONVI_TONGHOP,TBL1.ITONGHOP,KIENNGHI.ID_LINHVUC_KIENNGHI)
    --select * from kn_kiennghi;

    SELECT * FROM 
        ( SELECT k.*,(SELECT COUNT(*) FROM TBL4) AS TOTAL, ROWNUM r_ FROM( select * from TBL4 ) k WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
                        --LEFT JOIN TBL4 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL4.ICOQUAN_PARENT_THAMQUYEN_DONVI
                        --WHERE (p_ITHAMQUYENDONVI_PARENT=0 OR TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT);

  END PRC_TONGHOP_KIENNGHI_HUYEN;

	---------------------------------------------------------------------------------------------------

  PROCEDURE PRC_CHUONGTRINH_CHITIET(res out sys_refcursor,  p_ICHUONGTRINH in NUMBER ) AS
  BEGIN
    Open res for
    SELECT KN_CHUONGTRINH_CHITIET.ID,USER_PHONGBAN.CTEN AS TENDAIBIEU, DIAPHUONG1.IDIAPHUONG AS ID_DIAPHUONG, DIAPHUONG2.IDIAPHUONG AS ID_DIAPHUONG2, USER_PHONGBAN.IPHONGBAN AS ID_TODAIBIEU,KN_CHUONGTRINH_CHITIET.CDIACHI AS DIACHITIEP,
    KN_CHUONGTRINH_CHITIET.DNGAYTIEP AS NGAYTIEP,DIAPHUONG1.CTEN AS TENDIAPHUONG, DIAPHUONG2.CTEN AS TENDIAPHUONG2
  FROM KN_CHUONGTRINH_CHITIET LEFT JOIN USER_PHONGBAN ON USER_PHONGBAN.IPHONGBAN=KN_CHUONGTRINH_CHITIET.ITODAIBIEU
  LEFT JOIN DIAPHUONG DIAPHUONG1 ON DIAPHUONG1.IDIAPHUONG=KN_CHUONGTRINH_CHITIET.IDIAPHUONG
	LEFT JOIN DIAPHUONG DIAPHUONG2 ON DIAPHUONG2.IDIAPHUONG=KN_CHUONGTRINH_CHITIET.IDIAPHUONG2
  WHERE KN_CHUONGTRINH_CHITIET.ICHUONGTRINH=p_ICHUONGTRINH ORDER BY USER_PHONGBAN.IPHONGBAN
    ;  
  END PRC_CHUONGTRINH_CHITIET;



  /* CHUONG TRINH TIEP XUC CU TRI*/
  PROCEDURE PRC_CHUONGTRINH_TIEPXUC_CUTRI(res out sys_refcursor,  p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                                 p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                                 p_IDOAN_LAPKEHOACH in NUMBER,/* DEFAULT: 0*/   
                                                                 p_CNOIDUNG IN NVARCHAR2, /* DEFAULT: */
																																 p_LISTKYHOP in NVARCHAR2,
																																 p_USER IN NUMBER,/* DEFAULT: */
                                                                 p_PAGE IN NUMBER,/* DEFAULT: */
                                                                  p_PAGE_SIZE IN NUMBER/* DEFAULT: */		
                                                               ) AS
  BEGIN
    Open res for
    with CHUONGTRINH_DIAPHUONG as (
     -- select ICHUONGTRINH AS ID_CHUONGTRINH,LISTAGG(convert(DIAPHUONG.CTEN, 'UTF8', 'AL32UTF8'), ', ')
      select ICHUONGTRINH AS ID_CHUONGTRINH,LISTAGG(DIAPHUONG.CTEN, ', ')
      WITHIN GROUP (ORDER BY ICHUONGTRINH) TENDIAPHUONG1
      FROM KN_CHUONGTRINH_DIAPHUONG INNER JOIN DIAPHUONG ON  
      KN_CHUONGTRINH_DIAPHUONG.IDIAPHUONG1=DIAPHUONG.IDIAPHUONG GROUP BY ICHUONGTRINH
   ),  
   CHUONGTRINH_DAIBIEU as (
      select ICHUONGTRINH AS ID_CHUONGTRINH,LISTAGG(DAIBIEU.CTEN, ', ')
      WITHIN GROUP (ORDER BY ICHUONGTRINH) TENDAIBIEU
      FROM KN_CHUONGTRINH_DAIBIEU INNER JOIN DAIBIEU ON  
      KN_CHUONGTRINH_DAIBIEU.IUSER_DAIBIEU=DAIBIEU.IDAIBIEU GROUP BY ICHUONGTRINH
   ),
   TBL3 as(
    select KN_CHUONGTRINH.ICHUONGTRINH AS ICHUONGTRINH,
          KN_CHUONGTRINH.IDONVI AS ID_DIAPHUONGTIEPXUC,
          KN_CHUONGTRINH.IUSER AS ID_USER_CAPNHAT,KN_CHUONGTRINH.CKEHOACH AS CKEHOACH,
            KN_CHUONGTRINH.CNOIDUNG AS CNOIDUNG,KN_CHUONGTRINH.CDIACHI AS CDIACHI,
           KN_CHUONGTRINH.DBATDAU AS DBATDAU,KN_CHUONGTRINH.DKETTHUC AS DKETTHUC,
            DIAPHUONG0.CTEN AS TENDIAPHUONG,
           CHUONGTRINH_DIAPHUONG.TENDIAPHUONG1 AS TENDIAPHUONG1,
           --KN_CHUONGTRINH_DIAPHUONG.IDIAPHUONG1 AS ID_DIAPHUONG1,
           0 AS ID_DIAPHUONG1,
           --KN_CHUONGTRINH_DAIBIEU.IUSER_DAIBIEU AS ID_DAIBIEU,
           0 AS ID_DAIBIEU,
           CHUONGTRINH_DAIBIEU.TENDAIBIEU AS TENDAIBIEU
    FROM KN_CHUONGTRINH 
    LEFT JOIN CHUONGTRINH_DIAPHUONG ON CHUONGTRINH_DIAPHUONG.ID_CHUONGTRINH=KN_CHUONGTRINH.ICHUONGTRINH
    LEFT JOIN CHUONGTRINH_DAIBIEU ON CHUONGTRINH_DAIBIEU.ID_CHUONGTRINH=KN_CHUONGTRINH.ICHUONGTRINH
    --LEFT JOIN QUOCHOI_COQUAN ON KN_CHUONGTRINH.IDONVI=QUOCHOI_COQUAN.ICOQUAN
    LEFT JOIN QUOCHOI_COQUAN DIAPHUONG0 ON DIAPHUONG0.ICOQUAN=KN_CHUONGTRINH.IDONVI    
    --LEFT JOIN KN_CHUONGTRINH_DIAPHUONG ON KN_CHUONGTRINH_DIAPHUONG.ICHUONGTRINH=KN_CHUONGTRINH.ICHUONGTRINH
    --LEFT JOIN KN_CHUONGTRINH_DAIBIEU ON KN_CHUONGTRINH_DAIBIEU.ICHUONGTRINH=KN_CHUONGTRINH.ICHUONGTRINH
    --LEFT JOIN DIAPHUONG DIAPHUONG1 ON KN_CHUONGTRINH_DIAPHUONG.IDIAPHUONG1=DIAPHUONG1.IDIAPHUONG
    --LEFT JOIN DAIBIEU ON KN_CHUONGTRINH_DAIBIEU.IUSER_DAIBIEU=DAIBIEU.IDAIBIEU
    WHERE --(p_IKYHOP=0 OR KN_CHUONGTRINH.IKYHOP=p_IKYHOP) AND 
					(p_LISTKYHOP = '0' OR KN_CHUONGTRINH.IKYHOP IN (select regexp_substr(p_LISTKYHOP,'[^,]+', 1, level)
					from dual
					connect BY regexp_substr(p_LISTKYHOP, '[^,]+', 1, level)
					is not null)) AND
          (p_ITRUOCKYHOP=-1 OR KN_CHUONGTRINH.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
          (p_IDOAN_LAPKEHOACH=0 OR KN_CHUONGTRINH.IDONVI=p_IDOAN_LAPKEHOACH) AND 
					(p_USER=0 OR KN_CHUONGTRINH.IUSER=p_USER) AND 
          (UPPER(KN_CHUONGTRINH.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%' OR 
          UPPER(KN_CHUONGTRINH.CKEHOACH) LIKE '%' || UPPER(p_CNOIDUNG) || '%')
          ORDER BY KN_CHUONGTRINH.IDONVI
    --ORDER BY TENDIAPHUONG
    )
    SELECT * FROM 
        (
            SELECT k.*,(SELECT COUNT(*) FROM TBL3) AS TOTAL, 
            ROWNUM r_ FROM( select * from TBL3 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1)
    ;  
  END PRC_CHUONGTRINH_TIEPXUC_CUTRI;
   /* LISST KIENNGHI BY TONGHOP KIENNGHI*/
  PROCEDURE PRC_LIST_KIENNGHI_BY_TONGHOP(res out sys_refcursor,  p_ITONGHOP in NUMBER,p_ITONGHOP_BDN in NUMBER) AS
  BEGIN
    Open res for
        with tbl1 as
    (
    select KN_KIENNGHI.CNOIDUNG,KN_KIENNGHI.IKIENNGHI,KN_KIENNGHI.ID_GOP,
       KN_KIENNGHI.CDIACHI,KN_KIENNGHI.ITINHTRANG,QUOCHOI_COQUAN.CTEN AS TENDONVITIEPNHAN,
       DIAPHUONG0.CTEN AS TEN_TINH,DIAPHUONG1.CTEN AS TEN_HUYEN
    FROM KN_KIENNGHI 
      LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
      LEFT JOIN DIAPHUONG DIAPHUONG0 ON DIAPHUONG0.IDIAPHUONG=KN_KIENNGHI.IDIAPHUONG0 
      LEFT JOIN DIAPHUONG DIAPHUONG1 ON DIAPHUONG1.IDIAPHUONG=KN_KIENNGHI.IDIAPHUONG1 
    WHERE 
    (p_ITONGHOP=0 OR KN_KIENNGHI.ITONGHOP=p_ITONGHOP) AND 
    (p_ITONGHOP_BDN=0 OR KN_KIENNGHI.ITONGHOP_BDN=p_ITONGHOP_BDN) and ID_GOP<=0
    ),
    --union all
    KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
            KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
            WHERE KN_KIENNGHI.ID_GOP>0 ORDER BY KN_KIENNGHI.ID_GOP),
    TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
        LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
        (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP             
        )
    select * from tbl1 LEFT JOIN TBL2 on tbl1.IKIENNGHI=TBL2.ID_KIENNGHI_PARENT_GOP ORDER BY tbl1.ID_GOP;
    /*
    select KN_KIENNGHI.CNOIDUNG,
    KN_KIENNGHI.IKIENNGHI,
    KN_KIENNGHI.ID_GOP,
       KN_KIENNGHI.CDIACHI,
       KN_KIENNGHI.ITINHTRANG,
       (SELECT CTEN FROM QUOCHOI_COQUAN WHERE QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TENDONVITIEPNHAN,
       (SELECT CTEN FROM DIAPHUONG WHERE DIAPHUONG.IDIAPHUONG=KN_KIENNGHI.IDIAPHUONG0) AS TEN_TINH,
       (SELECT CTEN FROM DIAPHUONG WHERE DIAPHUONG.IDIAPHUONG=KN_KIENNGHI.IDIAPHUONG1) AS TEN_HUYEN
    FROM KN_KIENNGHI 
    LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
    LEFT JOIN DIAPHUONG ON DIAPHUONG.IDIAPHUONG=KN_KIENNGHI.IDIAPHUONG0 
    WHERE 
    (p_ITONGHOP=0 OR KN_KIENNGHI.ITONGHOP=p_ITONGHOP) AND 
    (p_ITONGHOP_BDN=0 OR KN_KIENNGHI.ITONGHOP_BDN=p_ITONGHOP_BDN)
    AND (KN_KIENNGHI.ID_GOP=0 OR KN_KIENNGHI.ID_GOP=-1)
    ORDER BY KN_KIENNGHI.IDONVITIEPNHAN;  
    */
  END PRC_LIST_KIENNGHI_BY_TONGHOP;
  /* LISST KIENNGHI MOI CAP NHAT BDN*/
  PROCEDURE PRC_KIENNGHI_MOICAPNHAT(res out sys_refcursor, p_IUSER in NUMBER, /* DEFAULT: -1*/
                                                               p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                               p_IDONVITIEPNHAN in NUMBER, /* DEFAULT: 0*/
                                                               p_INGUONKIENNGHI in NUMBER, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,/* DEFAULT: 0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_IDIAPHUONG0 in NUMBER,/* DEFAULT: 0*/
                                                               p_IDIAPHUONG1 in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2,/* DEFAULT: */
																															 p_LISTKYHOP in NVARCHAR2,
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                               ) AS
  BEGIN
    Open res for
    WITH TBL1 AS
    ( SELECT  KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.ID_GOP, KN_KIENNGHI.IUSER AS ID_USER_CAPNHAT,
              KN_KIENNGHI.IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,
              KN_KIENNGHI.ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN, KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              0 AS SOLUONG_KIENNGHI_GOP,
              COQUAN_TIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,ITINHTRANG,
              COQUAN_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,USERS.IDONVI AS ID_DONVI_CAPNHAT,
              COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI,LINHVUC_COQUAN.CTEN AS TEN_LINHVUC,              
              KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI, KN_KIENNGHI.IKYHOP
      FROM KN_KIENNGHI 
      LEFT JOIN QUOCHOI_COQUAN COQUAN_TIEPNHAN ON KN_KIENNGHI.IDONVITIEPNHAN=COQUAN_TIEPNHAN.ICOQUAN
      LEFT JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON KN_KIENNGHI.ITHAMQUYENDONVI=COQUAN_THAMQUYEN.ICOQUAN
      LEFT JOIN USERS ON USERS.IUSER=KN_KIENNGHI.IUSER
      LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      WHERE ID_GOP<=0 AND 
        KN_KIENNGHI.IDELETE=0 AND
        --(p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP or 
				(KN_KIENNGHI.IKYHOP IN (select regexp_substr(p_LISTKYHOP,'[^,]+', 1, level)
					from dual
					connect BY regexp_substr(p_LISTKYHOP, '[^,]+', 1, level)
					is not null) OR p_LISTKYHOP = '0') AND 
        (p_INGUONKIENNGHI =0 OR KN_KIENNGHI.INGUONKIENNGHI =p_INGUONKIENNGHI) AND 
        (p_IDIAPHUONG0 =0 OR KN_KIENNGHI.IDIAPHUONG0 =p_IDIAPHUONG0) AND 
        (p_IDIAPHUONG1 =0 OR KN_KIENNGHI.IDIAPHUONG1 =p_IDIAPHUONG1) AND 
        (p_ITHAMQUYENDONVI_PARENT=0 OR COQUAN_THAMQUYEN.IPARENT=p_ITHAMQUYENDONVI_PARENT) AND 
        (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITIEPNHAN=0 OR KN_KIENNGHI.IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
        (p_ITRUOCKYHOP=-1 OR KN_KIENNGHI.ITRUOCKYHOP=p_ITRUOCKYHOP) 
        AND (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) 
        and (p_IUSER=0 OR KN_KIENNGHI.IUSER=p_IUSER)
        AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
        ), 
        KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.IDELETE=0 AND KN_KIENNGHI.ID_GOP>0 AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) ORDER BY KN_KIENNGHI.ID_GOP),
        TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
            LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
            (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP             
            ),
        TBL3 AS(
        SELECT * FROM TBL1 LEFT JOIN TBL2 ON TBL1.ID_KIENNGHI=TBL2.ID_KIENNGHI_PARENT_GOP
        --WHERE (TBL1.ITINHTRANG=0 OR (TBL1.ITINHTRANG=0 AND (p_IUSER=0 OR TBL1.ID_USER_CAPNHAT=p_IUSER) AND TBL1.ID_DONVI_CAPNHAT=4))
        WHERE (TBL1.ITINHTRANG=0 OR (TBL1.ITINHTRANG=0 AND (p_IUSER=0 OR TBL1.ID_USER_CAPNHAT=p_IUSER) ))
        ORDER BY TBL1.ID_THAMQUYEN_DONVI,TBL1.ID_LINHVUC,TBL1.ID_KIENNGHI)
        SELECT * FROM 
        (
            SELECT k.*,(SELECT COUNT(*) FROM TBL3) AS TOTAL, 
            ROWNUM r_ FROM( select * from TBL3 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
  END PRC_KIENNGHI_MOICAPNHAT;
/* KIEN NGHI LIST*/
  PROCEDURE PRC_KIENNGHI_LIST(res out sys_refcursor,           p_ITINHTRANG IN NUMBER, /* DEFAULT: -1*/
                                                               p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                               p_IDONVITIEPNHAN in NUMBER, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,/* DEFAULT: 0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2,
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                               ) AS
  BEGIN
    Open res for
    WITH TBL1 AS
    ( SELECT  KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.ID_GOP, KN_KIENNGHI.IUSER AS ID_USER_CAPNHAT,
              KN_KIENNGHI.IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,
              KN_KIENNGHI.ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN, KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              --(SELECT COUNT(*) FROM KN_KIENNGHI WHERE ID_GOP=IKIENNGHI) AS SOLUONG_KIENNGHI_GOP,
              DONVI_TIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,ITINHTRANG,
              DONVI_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,
              USERS.IDONVI AS ID_DONVI_CAPNHAT,DONVI_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI,              
              LINHVUC_COQUAN.CTEN AS TEN_LINHVUC, CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI 
      LEFT JOIN QUOCHOI_COQUAN DONVI_TIEPNHAN ON KN_KIENNGHI.ITHAMQUYENDONVI=DONVI_TIEPNHAN.ICOQUAN
      LEFT JOIN QUOCHOI_COQUAN DONVI_THAMQUYEN ON KN_KIENNGHI.ITHAMQUYENDONVI=DONVI_THAMQUYEN.ICOQUAN
      LEFT JOIN USERS ON USERS.IUSER=KN_KIENNGHI.IUSER
      LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      WHERE KN_KIENNGHI.ID_GOP<=0 AND 
        (p_ITINHTRANG=-1 OR KN_KIENNGHI.ITINHTRANG=p_ITINHTRANG) AND
        (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND 
        (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITIEPNHAN=0 OR KN_KIENNGHI.IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
        (p_ITHAMQUYENDONVI_PARENT=0 OR DONVI_THAMQUYEN.IPARENT=p_ITHAMQUYENDONVI_PARENT) AND 
        (p_ITRUOCKYHOP=-1 OR KN_KIENNGHI.ITRUOCKYHOP=p_ITRUOCKYHOP) 
        AND (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)
        AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
        ),
        KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.ID_GOP>0 AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) ORDER BY KN_KIENNGHI.ID_GOP),
        TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
            LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
            (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP             
            ),
        TBL3 AS (SELECT * FROM TBL1 LEFT JOIN TBL2 ON TBL1.ID_KIENNGHI=TBL2.ID_KIENNGHI_PARENT_GOP)
        SELECT * FROM 
        (
            SELECT k.*,(SELECT COUNT(*) FROM TBL3) AS TOTAL, 
            ROWNUM r_ FROM( select * from TBL3 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
    /*
    WITH TBL1 AS
    ( SELECT  IKIENNGHI AS ID_KIENNGHI, ID_GOP, IUSER AS ID_USER_CAPNHAT,
              IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, ITONGHOP AS ID_KIENNGHI_TONGHOP,
              ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN, IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              (SELECT COUNT(*) FROM KN_KIENNGHI WHERE ID_GOP=IKIENNGHI) AS SOLUONG_KIENNGHI_GOP,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=IDONVITIEPNHAN) AS TEN_DONVITIEPNHAN,
              ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,ILINHVUC AS ID_LINHVUC,ITINHTRANG,
              (SELECT IPARENT FROM QUOCHOI_COQUAN WHERE ICOQUAN=ITHAMQUYENDONVI) AS ID_PARENT_THAMQUYEN_DONVI,
              (SELECT IDONVI FROM USERS WHERE IUSER=KN_KIENNGHI.IUSER) AS ID_DONVI_CAPNHAT,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=ITHAMQUYENDONVI) AS TEN_THAMQUYEN_DONVI,              
              (SELECT CTEN FROM LINHVUC_COQUAN WHERE ILINHVUC=KN_KIENNGHI.ILINHVUC) AS TEN_LINHVUC,              
              CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON KN_KIENNGHI.ITHAMQUYENDONVI=QUOCHOI_COQUAN.ICOQUAN
      WHERE (p_ITINHTRANG=-1 OR KN_KIENNGHI.ITINHTRANG=p_ITINHTRANG) AND
        (p_IKYHOP=0 OR IKYHOP=p_IKYHOP) AND 
        (p_ILINHVUC=-1 OR ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITIEPNHAN=0 OR IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
        (p_ITRUOCKYHOP=-1 OR ITRUOCKYHOP=p_ITRUOCKYHOP) 
        AND (p_ITHAMQUYENDONVI=0 OR ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)
        AND UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
        ), 
        TBL2 AS (SELECT CTEN AS TEN_PARENT_THAMQUYEN_DONVI,ICOQUAN AS ICOQUAN_PARENT_THAMQUYEN_DONVI 
                FROM QUOCHOI_COQUAN WHERE IPARENT=0 AND IHIENTHI=1),
        TBL3 as( select  KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TENDONVITIEPNHAN_GOP
            FROM KN_KIENNGHI  INNER JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN 
            )
        SELECT * FROM TBL1 LEFT JOIN TBL2 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL2.ICOQUAN_PARENT_THAMQUYEN_DONVI
                            LEFT JOIN TBL3 ON TBL1.ID_KIENNGHI=TBL3.ID_KIENNGHI_PARENT_GOP
        WHERE TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT OR p_ITHAMQUYENDONVI_PARENT=0;
        */
END PRC_KIENNGHI_LIST;
PROCEDURE PRC_KIENNGHI_LIST_TRUNG(res out sys_refcursor,       p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                               p_IDONVITIEPNHAN in NUMBER, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,/* DEFAULT: 0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2,
																															 p_LISTKYHOP IN NVARCHAR2,
                                                               p_IUSER_CAPNHAT IN NUMBER,--0
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                               ) AS
  BEGIN
    Open res for
    WITH TBL1 AS
    ( SELECT  KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.ID_GOP, KN_KIENNGHI.IUSER AS ID_USER_CAPNHAT,
              KN_KIENNGHI.IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,
              KN_KIENNGHI.ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN, KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              --(SELECT COUNT(*) FROM KN_KIENNGHI WHERE ID_GOP=IKIENNGHI) AS SOLUONG_KIENNGHI_GOP,
              DONVI_TIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,ITINHTRANG,
              DONVI_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,
              USERS.IDONVI AS ID_DONVI_CAPNHAT,DONVI_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI,              
              LINHVUC_COQUAN.CTEN AS TEN_LINHVUC, CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI 
      LEFT JOIN QUOCHOI_COQUAN DONVI_TIEPNHAN ON KN_KIENNGHI.ITHAMQUYENDONVI=DONVI_TIEPNHAN.ICOQUAN
      LEFT JOIN QUOCHOI_COQUAN DONVI_THAMQUYEN ON KN_KIENNGHI.ITHAMQUYENDONVI=DONVI_THAMQUYEN.ICOQUAN
      LEFT JOIN USERS ON USERS.IUSER=KN_KIENNGHI.IUSER
      LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      WHERE  1=1
      and (p_IUSER_CAPNHAT =0 or KN_KIENNGHI.IUSER =  p_IUSER_CAPNHAT)
      --AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP = p_IKYHOP)
			AND (KN_KIENNGHI.IKYHOP IN (select regexp_substr(p_LISTKYHOP,'[^,]+', 1, level)
					from dual
					connect BY regexp_substr(p_LISTKYHOP, '[^,]+', 1, level)
					is not null) OR p_LISTKYHOP = '0')  
      AND (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC = p_ILINHVUC)
      --AND (KN_KIENNGHI.IDONVITIEPNHAN = 0 OR KN_KIENNGHI.IDONVITIEPNHAN = p_IDONVITIEPNHAN)
      AND (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI = p_ITHAMQUYENDONVI)
      AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
			--or  (KN_KIENNGHI.ITONGHOP IN ( SELECT ITONGHOP FROM KN_TONGHOP WHERE   KN_TONGHOP.IUSER =  p_IUSER_CAPNHAT )))
      --KN_KIENNGHI.ID_GOP<=0 AND 
      --KN_KIENNGHI.ITINHTRANG>=3 AND 
      AND KN_KIENNGHI.IKIENNGHI_TRUNG!=0 AND KN_KIENNGHI.IKIEMTRATRUNG=1 
      AND KN_KIENNGHI.ITINHTRANG = 7
        )
        SELECT * FROM 
        (
            SELECT k.*,(SELECT COUNT(*) FROM TBL1) AS TOTAL, 
            ROWNUM r_ FROM( select * from TBL1 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
END PRC_KIENNGHI_LIST_TRUNG;
/* KIEN NGHI LIST*/
  PROCEDURE PRC_KIENNGHI_LIST_TRACUU(res out sys_refcursor,    p_ITINHTRANG IN NUMBER, /* DEFAULT: -1*/
                                                               p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                               p_IDONVITIEPNHAN in NUMBER, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,/* DEFAULT: 0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2, /* DEFAULT: */
                                                               p_IUSER_CAPNHAT IN NUMBER,--0
                                                               p_NGAYNHAN_FROM IN DATE,
                                                               p_NGAYNHAN_TO IN DATE,
                                                               p_NGAYTONGHOP_FROM IN DATE,
                                                               p_NGAYTONGHOP_TO IN DATE,
                                                               p_NGAYTRALOI_FROM IN DATE,
                                                               p_NGAYTRALOI_TO IN DATE,
                                                               p_TINHTRANG_FROM IN NUMBER,
                                                               p_TINHTRANG_TO IN NUMBER,
                                                               p_KETQUA_GIAMSAT IN NUMBER,
                                                               p_DA_TRALOI IN NUMBER,
                                                               p_PAGE IN NUMBER,
                                                               p_PAGE_SIZE IN NUMBER    
                                                               ) AS
  BEGIN
    Open res for
    WITH 
    TRALOI AS(SELECT COUNT(*) AS DATRALOI,KN_KIENNGHI_TRALOI.IKIENNGHI AS ID_KIENNGHI 
          FROM KN_KIENNGHI_TRALOI INNER JOIN KN_KIENNGHI ON KN_KIENNGHI.IKIENNGHI=KN_KIENNGHI_TRALOI.IKIENNGHI
          GROUP BY KN_KIENNGHI_TRALOI.IKIENNGHI),
    TBL1 AS
    (SELECT   KN_KIENNGHI.IDELETE AS IDELETE,KN_KIENNGHI.IUSER AS IUSER,
              KN_KIENNGHI.DDATE AS NGAYCAPNHAT,VANBAN_CHUYEN_BDN.DDATE AS NGAYTONGHOP,
              KN_KIENNGHI_TRALOI.DNGAYBANHANH AS TRALOI_NGAYBANHANH,
              VANBAN_CHUYEN_BDN.DNGAYBANHANH AS NGAY_CHUYEN,
              KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, ID_GOP, KN_KIENNGHI.IUSER AS ID_USER_CAPNHAT,
              IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,
              KN_KIENNGHI.ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN, KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              DONVI_TIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,KN_KIENNGHI.ITINHTRANG,
              DONVI_THAMQUYEN_PARENT.CTEN AS TEN_PARENT_THAMQUYEN_DONVI,
              COALESCE(KN_GIAMSAT.IDONGKIENNGHI, -1) AS GIAMSAT_DONGKIENNGHI,
              DONVI_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI,LINHVUC_COQUAN.CTEN AS TEN_LINHVUC, 
              KN_KIENNGHI_TRALOI.CSOVANBAN AS TRALOI_SOVANBAN,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI,
              COALESCE(TRALOI.DATRALOI,0) AS DATRALOI
      FROM KN_KIENNGHI 
      LEFT JOIN QUOCHOI_COQUAN DONVI_TIEPNHAN ON DONVI_TIEPNHAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
      LEFT JOIN QUOCHOI_COQUAN DONVI_THAMQUYEN ON DONVI_THAMQUYEN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
      LEFT JOIN QUOCHOI_COQUAN DONVI_THAMQUYEN_PARENT ON DONVI_THAMQUYEN_PARENT.ICOQUAN=DONVI_THAMQUYEN.IPARENT
      --LEFT JOIN KN_TONGHOP ON (KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP_BDN OR KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP)
      LEFT JOIN KN_TONGHOP TONGHOP_BDN ON TONGHOP_BDN.ITONGHOP=KN_KIENNGHI.ITONGHOP_BDN 
      LEFT JOIN KN_TONGHOP TONGHOP_DOAN ON TONGHOP_DOAN.ITONGHOP=KN_KIENNGHI.ITONGHOP 
      LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      LEFT JOIN KN_VANBAN VANBAN_CHUYEN_BDN ON TONGHOP_DOAN.ITONGHOP=VANBAN_CHUYEN_BDN.ITONGHOP 
      LEFT JOIN KN_VANBAN VANBAN_CHUYEN_DONVI ON TONGHOP_BDN.ITONGHOP=VANBAN_CHUYEN_DONVI.ITONGHOP 
      LEFT JOIN KN_KIENNGHI_TRALOI ON KN_KIENNGHI_TRALOI.IKIENNGHI=KN_KIENNGHI.IKIENNGHI
      LEFT JOIN KN_GIAMSAT ON KN_GIAMSAT.IKIENNGHI=KN_KIENNGHI.IKIENNGHI
      LEFT JOIN TRALOI ON KN_KIENNGHI.IKIENNGHI=TRALOI.ID_KIENNGHI
      WHERE 1=1
        AND (p_ITINHTRANG=-1 OR KN_KIENNGHI.ITINHTRANG=p_ITINHTRANG) AND
        (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND 
        (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITIEPNHAN=0 OR KN_KIENNGHI.IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
        (p_ITRUOCKYHOP=-1 OR KN_KIENNGHI.ITRUOCKYHOP=p_ITRUOCKYHOP) 
        AND (KN_KIENNGHI.IUSER=p_IUSER_CAPNHAT OR p_IUSER_CAPNHAT=0)
       AND (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)
        AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
        --AND (DONVI_THAMQUYEN_PARENT.ICOQUAN=p_ITHAMQUYENDONVI_PARENT OR p_ITHAMQUYENDONVI_PARENT=0)
        AND (to_date(KN_KIENNGHI.DDATE) BETWEEN p_NGAYNHAN_FROM AND p_NGAYNHAN_TO)
        --AND (to_date(TONGHOP_BDN.DDATE) BETWEEN p_NGAYTONGHOP_FROM AND p_NGAYTONGHOP_TO)
       --AND (KN_KIENNGHI_TRALOI.DNGAYBANHANH IS NULL OR to_date(KN_KIENNGHI_TRALOI.DNGAYBANHANH) BETWEEN p_NGAYTRALOI_FROM AND p_NGAYTRALOI_TO)
        ),
        KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.ID_GOP>0 AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) ORDER BY KN_KIENNGHI.ID_GOP),
        TBL3 as( select COALESCE(KN_GOP.ID_KIENNGHI_PARENT_GOP,0) AS ID_KIENNGHI_PARENT_GOP,
            LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
            (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP),
        TBL4 AS(SELECT TBL1.*,TBL3.TENDONVITIEPNHAN_GOP FROM TBL1 LEFT JOIN TBL3 ON TBL1.ID_KIENNGHI=TBL3.ID_KIENNGHI_PARENT_GOP
           WHERE 
            TBL1.ITINHTRANG BETWEEN p_TINHTRANG_FROM AND p_TINHTRANG_TO 
            AND (p_KETQUA_GIAMSAT=-1 OR TBL1.GIAMSAT_DONGKIENNGHI=p_KETQUA_GIAMSAT)            
            AND (p_DA_TRALOI=-1 OR TBL1.DATRALOI=p_DA_TRALOI) 
            ORDER BY TBL1.ID_THAMQUYEN_DONVI,TBL1.ID_LINHVUC
        )
        SELECT * FROM 
        (
            SELECT k.*,(SELECT COUNT(*) FROM TBL4) AS TOTAL, 
            ROWNUM r_ FROM( select * from TBL4 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1)
         ;

    /*    
    WITH TBL1 AS
    (SELECT   
              KN_KIENNGHI.DDATE AS NGAYCAPNHAT,KN_TONGHOP.DDATE AS NGAYTONGHOP,
              KN_KIENNGHI_TRALOI.DNGAYBANHANH AS TRALOI_NGAYBANHANH,
              KN_VANBAN.DNGAYBANHANH AS NGAY_CHUYEN,
              KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, ID_GOP, KN_KIENNGHI.IUSER AS ID_USER_CAPNHAT,
              IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,
              KN_KIENNGHI.ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN, KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              (SELECT COUNT(*) FROM KN_KIENNGHI WHERE ID_GOP=IKIENNGHI) AS SOLUONG_KIENNGHI_GOP,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=IDONVITIEPNHAN) AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,KN_KIENNGHI.ITINHTRANG,
              (SELECT IPARENT FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS ID_PARENT_THAMQUYEN_DONVI,
              (SELECT IDONVI FROM USERS WHERE IUSER=KN_KIENNGHI.IUSER) AS ID_DONVI_CAPNHAT,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS TEN_THAMQUYEN_DONVI,              
              (SELECT CTEN FROM LINHVUC_COQUAN WHERE ILINHVUC=KN_KIENNGHI.ILINHVUC) AS TEN_LINHVUC, 
              (SELECT CSOVANBAN FROM KN_KIENNGHI_TRALOI WHERE IKIENNGHI=KN_KIENNGHI.IKIENNGHI) AS TRALOI_SOVANBAN,
              KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI 
      INNER JOIN KN_TONGHOP ON KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP_BDN
      INNER JOIN KN_VANBAN ON KN_TONGHOP.ITONGHOP=KN_VANBAN.IVANBAN 
      LEFT JOIN KN_KIENNGHI_TRALOI ON KN_KIENNGHI_TRALOI.IKIENNGHI=KN_KIENNGHI.IKIENNGHI
      WHERE KN_VANBAN.CLOAI='tonghop_chuyendonvi_xuly' AND
      (p_ITINHTRANG=-1 OR KN_KIENNGHI.ITINHTRANG=p_ITINHTRANG) AND
        (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND 
        (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITIEPNHAN=0 OR KN_KIENNGHI.IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
        (p_ITRUOCKYHOP=-1 OR KN_KIENNGHI.ITRUOCKYHOP=p_ITRUOCKYHOP) 
        AND (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)
        AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
        ), 
        TBL2 AS (SELECT CTEN AS TEN_PARENT_THAMQUYEN_DONVI,ICOQUAN AS ICOQUAN_PARENT_THAMQUYEN_DONVI 
                FROM QUOCHOI_COQUAN WHERE IPARENT=0 AND IHIENTHI=1),
        TBL3 as( select  KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TENDONVITIEPNHAN_GOP
            FROM KN_KIENNGHI  INNER JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN 
            )
        SELECT * FROM TBL1 LEFT JOIN TBL2 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL2.ICOQUAN_PARENT_THAMQUYEN_DONVI
                            LEFT JOIN TBL3 ON TBL1.ID_KIENNGHI=TBL3.ID_KIENNGHI_PARENT_GOP
        WHERE TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT OR p_ITHAMQUYENDONVI_PARENT=0;
        */
END PRC_KIENNGHI_LIST_TRACUU;
PROCEDURE PRC_TRACUU_TRUNG(res out sys_refcursor,    p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                               p_IDONVITIEPNHAN in NUMBER, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT IN NUMBER,/* DEFAULT: 0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2,/* DEFAULT: */ 
                                                               p_NGAYNHAN_FROM IN DATE,
                                                               p_NGAYNHAN_TO IN DATE,
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                               ) AS
  BEGIN
    Open res for
    with TBL4 as (SELECT   
              KN_KIENNGHI.DDATE AS NGAYCAPNHAT,
              KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.IUSER AS ID_USER_CAPNHAT,
              IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              DONVI_TIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,KN_KIENNGHI.ITINHTRANG,
              DONVI_THAMQUYEN_PARENT.CTEN AS TEN_PARENT_THAMQUYEN_DONVI,
              DONVI_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI,              
              LINHVUC_COQUAN.CTEN AS TEN_LINHVUC, 
              KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI 
      LEFT JOIN QUOCHOI_COQUAN DONVI_TIEPNHAN ON DONVI_TIEPNHAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
      LEFT JOIN QUOCHOI_COQUAN DONVI_THAMQUYEN ON DONVI_THAMQUYEN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
      LEFT JOIN QUOCHOI_COQUAN DONVI_THAMQUYEN_PARENT ON DONVI_THAMQUYEN_PARENT.ICOQUAN=DONVI_THAMQUYEN.IPARENT
      LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      WHERE KN_KIENNGHI.ID_GOP<=0 AND KN_KIENNGHI.ITINHTRANG=7 AND
        (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND 
        (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITIEPNHAN=0 OR KN_KIENNGHI.IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
        (p_ITRUOCKYHOP=-1 OR KN_KIENNGHI.ITRUOCKYHOP=p_ITRUOCKYHOP) 
        AND (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)
        AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
        AND (DONVI_THAMQUYEN_PARENT.ICOQUAN=p_ITHAMQUYENDONVI_PARENT OR p_ITHAMQUYENDONVI_PARENT=0)
        AND to_date(KN_KIENNGHI.DDATE) BETWEEN p_NGAYNHAN_FROM AND p_NGAYNHAN_TO
        ORDER BY KN_KIENNGHI.DDATE)
      SELECT * FROM 
        (
            SELECT k.*,(SELECT COUNT(*) FROM TBL4) AS TOTAL, 
            ROWNUM r_ FROM( select * from TBL4 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);

END PRC_TRACUU_TRUNG;
/* KIEN NGHI LIST*/
/*
  PROCEDURE PRC_KIENNGHI_CHUYENKYSAU(res out sys_refcursor,           
                                                               p_ILINHVUC IN NUMBER, -- DEFAULT: -1
                                                               p_IDONVITIEPNHAN in NUMBER, -- DEFAULT: 0
                                                               p_IKYHOP in NUMBER, -- DEFAULT: 0
                                                               p_ITRUOCKYHOP IN NUMBER, -- DEFAULT: -1
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,-- DEFAULT: 0
                                                               p_ITHAMQUYENDONVI in NUMBER,-- DEFAULT: 0
                                                               p_CNOIDUNG IN NVARCHAR2 -- DEFAULT: 
                                                               ) AS
  BEGIN
    Open res for
    WITH TBL1 AS
    ( SELECT  KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.ID_GOP, 
              KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,KN_KIENNGHI.ITINHTRANG,
              (SELECT IPARENT FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS ID_PARENT_THAMQUYEN_DONVI,  
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS TEN_THAMQUYEN_DONVI,
              (SELECT CTEN FROM LINHVUC_COQUAN WHERE ILINHVUC=KN_KIENNGHI.ILINHVUC) AS TEN_LINHVUC,   
              CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI INNER JOIN KN_KIENNGHI_TRALOI ON KN_KIENNGHI.IKIENNGHI=KN_KIENNGHI_TRALOI.IKIENNGHI
                       INNER JOIN KN_GIAMSAT ON KN_KIENNGHI.IKIENNGHI=KN_GIAMSAT.IKIENNGHI                       
      WHERE KN_GIAMSAT.IDONGKIENNGHI=0 AND
        (p_IKYHOP=0 OR IKYHOP=p_IKYHOP) AND 
        (p_ILINHVUC=-1 OR ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITIEPNHAN=0 OR IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
        (p_ITRUOCKYHOP=-1 OR ITRUOCKYHOP=p_ITRUOCKYHOP) 
        AND (p_ITHAMQUYENDONVI=0 OR ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)
        AND UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
        ), 
        TBL2 AS (SELECT CTEN AS TEN_PARENT_THAMQUYEN_DONVI,ICOQUAN AS ICOQUAN_PARENT_THAMQUYEN_DONVI 
                FROM QUOCHOI_COQUAN WHERE IPARENT=0 AND IHIENTHI=1),
        TBL3 as( select  KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TENDONVITIEPNHAN_GOP
            FROM KN_KIENNGHI  INNER JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN 
            ),
        TBL4 AS (SELECT KN_GIAMSAT.IKIENNGHI AS ID_KIENNGHI_DANHGIA, CTRALOI AS NOIDUNG_TRALOI,CSOVANBAN AS SOVANBAN_TRALOI,KN_KIENNGHI_TRALOI.DNGAYBANHANH AS NGAYBANHANH_TRALOI,
                  (SELECT CTEN FROM KN_TRALOI_PHANLOAI WHERE IPHANLOAI=KN_KIENNGHI_TRALOI.IPHANLOAI)AS PHANLOAI_TRALOI, 
                  (SELECT CTEN FROM KN_TRALOI_PHANLOAI WHERE IPHANLOAI=KN_GIAMSAT.IPHANLOAI)AS PHANLOAI_DANHGIA 
                  FROM KN_KIENNGHI_TRALOI INNER JOIN KN_GIAMSAT ON KN_KIENNGHI_TRALOI.ITRALOI=KN_GIAMSAT.ITRALOI 
                  WHERE KN_GIAMSAT.IDONGKIENNGHI=0)            
        SELECT * FROM TBL1 LEFT JOIN TBL2 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL2.ICOQUAN_PARENT_THAMQUYEN_DONVI
                            LEFT JOIN TBL3 ON TBL1.ID_KIENNGHI=TBL3.ID_KIENNGHI_PARENT_GOP
                            INNER JOIN TBL4 ON TBL4.ID_KIENNGHI_DANHGIA=TBL1.ID_KIENNGHI
        WHERE TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT OR p_ITHAMQUYENDONVI_PARENT=0;

END PRC_KIENNGHI_CHUYENKYSAU;
*/
/* KIEN NGHI LIST*/
/*
  PROCEDURE PRC_KIENNGHI_TRALAI(res out sys_refcursor,           
                                                               p_ILINHVUC IN NUMBER,  --DEFAULT: -1
                                                               p_IDONVITIEPNHAN in NUMBER, -- DEFAULT: 0
                                                               p_IKYHOP in NUMBER, -- DEFAULT: 0
                                                               p_ITRUOCKYHOP IN NUMBER, -- DEFAULT: -1
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,-- DEFAULT: 0
                                                               p_ITHAMQUYENDONVI in NUMBER,-- DEFAULT: 0
                                                               p_CNOIDUNG IN NVARCHAR2 -- DEFAULT: 
                                                               ) AS
  BEGIN
    Open res for
    WITH TBL1 AS
    ( SELECT  KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.ID_GOP, 
              KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,KN_KIENNGHI.ITINHTRANG,
              (SELECT IPARENT FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS ID_PARENT_THAMQUYEN_DONVI,  
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS TEN_THAMQUYEN_DONVI,
              (SELECT CTEN FROM LINHVUC_COQUAN WHERE ILINHVUC=KN_KIENNGHI.ILINHVUC) AS TEN_LINHVUC,   
              CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI INNER JOIN KN_KIENNGHI_TRALOI ON KN_KIENNGHI.IKIENNGHI=KN_KIENNGHI_TRALOI.IKIENNGHI
      WHERE KN_KIENNGHI_TRALOI.ITINHTRANG=2 AND
        (p_IKYHOP=0 OR IKYHOP=p_IKYHOP) AND 
        (p_ILINHVUC=-1 OR ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITIEPNHAN=0 OR IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
        (p_ITRUOCKYHOP=-1 OR ITRUOCKYHOP=p_ITRUOCKYHOP) 
        AND (p_ITHAMQUYENDONVI=0 OR ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)
        AND UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
        ), 
        TBL2 AS (SELECT CTEN AS TEN_PARENT_THAMQUYEN_DONVI,ICOQUAN AS ICOQUAN_PARENT_THAMQUYEN_DONVI 
                FROM QUOCHOI_COQUAN WHERE IPARENT=0 AND IHIENTHI=1),
        TBL3 as( select  KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TENDONVITIEPNHAN_GOP
            FROM KN_KIENNGHI  INNER JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN 
            ),
        TBL4 AS (SELECT KN_KIENNGHI_TRALOI.IKIENNGHI AS ID_KIENNGHI_TRALOI, CTRALOI AS NOIDUNG_TRALOI,CSOVANBAN AS SOVANBAN_TRALOI,KN_KIENNGHI_TRALOI.DNGAYBANHANH AS NGAYBANHANH_TRALOI,
                  (SELECT CTEN FROM KN_TRALOI_PHANLOAI WHERE IPHANLOAI=KN_KIENNGHI_TRALOI.IPHANLOAI)AS PHANLOAI_TRALOI, 
                  (SELECT CTEN FROM KN_TRALOI_PHANLOAI WHERE IPHANLOAI=KN_GIAMSAT.IPHANLOAI)AS PHANLOAI_DANHGIA 
                  FROM KN_KIENNGHI_TRALOI LEFT JOIN KN_GIAMSAT ON KN_KIENNGHI_TRALOI.ITRALOI=KN_GIAMSAT.ITRALOI 
                  WHERE KN_KIENNGHI_TRALOI.ITINHTRANG=2)            
        SELECT * FROM TBL1 LEFT JOIN TBL2 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL2.ICOQUAN_PARENT_THAMQUYEN_DONVI
                            LEFT JOIN TBL3 ON TBL1.ID_KIENNGHI=TBL3.ID_KIENNGHI_PARENT_GOP
                            LEFT JOIN TBL4 ON TBL4.ID_KIENNGHI_TRALOI=TBL1.ID_KIENNGHI
        WHERE TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT OR p_ITHAMQUYENDONVI_PARENT=0;

END PRC_KIENNGHI_TRALAI;
*/
  /* LISST KIENNGHI MOI CAP NHAT CUA DIAPHUONG*/
  PROCEDURE PRC_KIENNGHI_MOICAPNHAT_DP(res out sys_refcursor, p_IUSER in NUMBER, /* DEFAULT: -1*/
                                                                 p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                                 p_IDONVITIEPNHAN in NUMBER, /* DEFAULT: 0*/
                                                                 p_INGUONKIENNGHI in NUMBER, /* DEFAULT: 0*/
                                                                 p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                                 p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                                 p_ITHAMQUYENDONVI_PARENT IN NUMBER,/* DEFAULT: 0*/
                                                                 p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                                 p_CNOIDUNG IN NVARCHAR2,/* DEFAULT: */
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                                 ) AS
    BEGIN
      Open res for
      with tbl1 as (SELECT  KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.ID_GOP, KN_KIENNGHI.IUSER AS ID_USER_CAPNHAT,
              KN_KIENNGHI.IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,
              KN_KIENNGHI.ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN, KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              0 AS SOLUONG_KIENNGHI_GOP,COQUAN_TIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,ITINHTRANG,
              COQUAN_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,
              COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI,LINHVUC_COQUAN.CTEN AS TEN_LINHVUC,              
              KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI 
      INNER JOIN QUOCHOI_COQUAN COQUAN_TIEPNHAN ON COQUAN_TIEPNHAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
      INNER JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON COQUAN_THAMQUYEN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
      LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC      
      WHERE 
      KN_KIENNGHI.ID_GOP<1 AND KN_KIENNGHI.ITINHTRANG=0 AND KN_KIENNGHI.ITONGHOP=0 AND
      (p_ITHAMQUYENDONVI_PARENT=0 OR COQUAN_THAMQUYEN.IPARENT=p_ITHAMQUYENDONVI_PARENT) AND
      (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND (p_IUSER=0 OR KN_KIENNGHI.IUSER=p_IUSER) AND 
        (p_INGUONKIENNGHI =0 OR KN_KIENNGHI.INGUONKIENNGHI =p_INGUONKIENNGHI) AND 
      (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC=p_ILINHVUC) AND (p_IDONVITIEPNHAN=0 OR KN_KIENNGHI.IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
      (p_ITRUOCKYHOP=-1 OR KN_KIENNGHI.ITRUOCKYHOP=p_ITRUOCKYHOP) AND (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) 
      AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
      ORDER BY KN_KIENNGHI.ITHAMQUYENDONVI,KN_KIENNGHI.ILINHVUC,KN_KIENNGHI.IKIENNGHI)
      SELECT * FROM 
        (
            SELECT k.*,(SELECT COUNT(*) FROM tbl1) AS TOTAL, 
            ROWNUM r_ FROM( select * from tbl1 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
      /*
      WITH TBL1 AS
    ( SELECT  IKIENNGHI AS ID_KIENNGHI, ID_GOP, IUSER AS ID_USER_CAPNHAT,
              IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, ITONGHOP AS ID_KIENNGHI_TONGHOP,
              ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN, IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              (SELECT COUNT(*) FROM KN_KIENNGHI WHERE ID_GOP=IKIENNGHI) AS SOLUONG_KIENNGHI_GOP,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=IDONVITIEPNHAN) AS TEN_DONVITIEPNHAN,
              ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,ILINHVUC AS ID_LINHVUC,ITINHTRANG,
              (SELECT IPARENT FROM QUOCHOI_COQUAN WHERE ICOQUAN=ITHAMQUYENDONVI) AS ID_PARENT_THAMQUYEN_DONVI,
              (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=ITHAMQUYENDONVI) AS TEN_THAMQUYEN_DONVI,              
              (SELECT CTEN FROM LINHVUC_COQUAN WHERE ILINHVUC=KN_KIENNGHI.ILINHVUC) AS TEN_LINHVUC,              
              CNOIDUNG AS NOIDUNG_KIENNGHI
      FROM KN_KIENNGHI WHERE 
      ID_GOP<1 AND ITINHTRANG=0 AND ITONGHOP=0 AND
      (p_IKYHOP=0 OR IKYHOP=p_IKYHOP) AND (p_IUSER=0 OR IUSER=p_IUSER) AND 
      (p_ILINHVUC=-1 OR ILINHVUC=p_ILINHVUC) AND (p_IDONVITIEPNHAN=0 OR IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
      (p_ITRUOCKYHOP=-1 OR ITRUOCKYHOP=p_ITRUOCKYHOP) AND (p_ITHAMQUYENDONVI=0 OR ITHAMQUYENDONVI=p_ITHAMQUYENDONVI) 
      AND ITHAMQUYENDONVI!=0 AND UPPER(CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
      ), TBL2 AS (SELECT CTEN AS TEN_PARENT_THAMQUYEN_DONVI,ICOQUAN AS ICOQUAN_PARENT_THAMQUYEN_DONVI 
                FROM QUOCHOI_COQUAN WHERE IPARENT=0 AND IHIENTHI=1)
        SELECT * FROM TBL1 LEFT JOIN TBL2 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL2.ICOQUAN_PARENT_THAMQUYEN_DONVI
        WHERE (TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT OR p_ITHAMQUYENDONVI_PARENT=0);
        */
  END PRC_KIENNGHI_MOICAPNHAT_DP;
  /* LISST TONG HOP KIEN NGHI*/
  PROCEDURE PRC_LIST_TONGHOP_KIENNGHI(res out sys_refcursor, p_ITINHTRANG in NUMBER, /* DEFAULT: -1*/
                                                                 p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                                 p_IDONVITONGHOP in NUMBER, /* DEFAULT: 0*/
                                                                 p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                                 p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                                 p_ITHAMQUYENDONVI_PARENT IN NUMBER,
                                                                 p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                                 p_CNOIDUNG IN NVARCHAR2,/* DEFAULT: */ 
                                                                 p_TINHTRANG_FROM IN NUMBER,
                                                               p_TINHTRANG_TO IN NUMBER,
                                                               p_CHUA_TRALOI IN NUMBER,
                                                               p_DA_TRALOI IN NUMBER,
                                                               p_TRALOI_KIENNGHI IN NUMBER,
                                                               p_DATRALOI_KIENNGHI IN NUMBER,
                                                                p_PAGE IN NUMBER,/* DEFAULT: */
                                                                p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                                 ) AS
    BEGIN
      Open res for
      WITH 
      SOKIENNGHI_TONGHOP as (
          SELECT COUNT(*) AS TONGSOKIENNGHI,KN_TONGHOP.ITONGHOP AS ID_TONGHOP FROM KN_TONGHOP
                INNER JOIN KN_KIENNGHI  ON (KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP OR KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP_BDN)
                WHERE KN_KIENNGHI.ID_GOP<=0 GROUP BY KN_TONGHOP.ITONGHOP
      ),
      SOKIENNGHI_TRALOI as (
          SELECT COUNT(*) AS TONGSOKIENNGHI_TRALOI,KN_TONGHOP.ITONGHOP AS ID_TONGHOP FROM KN_TONGHOP 
                INNER JOIN KN_KIENNGHI ON (KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP OR KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP_BDN)
                INNER JOIN KN_KIENNGHI_TRALOI ON KN_KIENNGHI.IKIENNGHI=KN_KIENNGHI_TRALOI.IKIENNGHI 
                WHERE KN_KIENNGHI.ID_GOP<=0 GROUP BY KN_TONGHOP.ITONGHOP
      ),
        TBL3 as (SELECT  KN_TONGHOP.ITONGHOP,KN_TONGHOP.ITINHTRANG,KN_TONGHOP.IUSER AS IUSER_CAPNHAT,            
            COQUAN_TONGHOP.CTEN AS TEN_DONVITONGHOP,KN_TONGHOP.IDONVITONGHOP AS ID_DONVITONGHOP,
            KN_TONGHOP.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI_TONGHOP,COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI_TONGHOP,
            LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_TONGHOP,KN_TONGHOP.ILINHVUC AS ID_LINHVUC_TONGHOP,            
            COQUAN_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,KN_VANBAN.DNGAYDUKIENHOANTHANH AS NGAYDUKIENHOANTHANH,
            KN_VANBAN.DNGAYBANHANH AS NGAYBANHANH_VANBAN,KN_TONGHOP.CNOIDUNG AS NOIDUNG_TONGHOP, 
            COQUAN_THAMQUYEN_PARENT.CTEN AS TEN_PARENT_THAMQUYEN_DONVI,
            COALESCE(SOKIENNGHI_TONGHOP.TONGSOKIENNGHI,0) AS SOKIENNGHI_TONGHOP,
            COALESCE(SOKIENNGHI_TRALOI.TONGSOKIENNGHI_TRALOI,0) AS SOKIENNGHI_DATRALOI,
            (COALESCE(SOKIENNGHI_TONGHOP.TONGSOKIENNGHI,0)-COALESCE(SOKIENNGHI_TRALOI.TONGSOKIENNGHI_TRALOI,0)) AS SOKIENNGHI_CHUATRALOI
        FROM KN_TONGHOP INNER JOIN KN_VANBAN ON KN_TONGHOP.ITONGHOP=KN_VANBAN.ITONGHOP 
        INNER JOIN QUOCHOI_COQUAN COQUAN_TONGHOP ON KN_TONGHOP.IDONVITONGHOP=COQUAN_TONGHOP.ICOQUAN 
        INNER JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON KN_TONGHOP.ITHAMQUYENDONVI=COQUAN_THAMQUYEN.ICOQUAN 
        INNER JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN_PARENT ON COQUAN_THAMQUYEN.IPARENT=COQUAN_THAMQUYEN_PARENT.ICOQUAN 
        LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_TONGHOP.ILINHVUC
        LEFT JOIN SOKIENNGHI_TONGHOP ON SOKIENNGHI_TONGHOP.ID_TONGHOP=KN_TONGHOP.ITONGHOP
        LEFT JOIN SOKIENNGHI_TRALOI ON SOKIENNGHI_TRALOI.ID_TONGHOP=KN_TONGHOP.ITONGHOP
        WHERE 
        --SOKIENNGHI_TONGHOP.TONGSOKIENNGHI>0 AND 
        (KN_VANBAN.CLOAI='tonghop_chuyendonvi_xuly' OR KN_VANBAN.CLOAI='tonghop_chuyenxuly') AND
         KN_TONGHOP.ITINHTRANG>=0  AND (p_ITINHTRANG=-1 OR KN_TONGHOP.ITINHTRANG=p_ITINHTRANG) AND 
        (p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP) AND 
        (p_ILINHVUC=-1 OR KN_TONGHOP.ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITONGHOP=0 OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) AND 
        (p_ITRUOCKYHOP=-1 OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
        (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)  
        AND UPPER(KN_TONGHOP.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
        AND (COQUAN_THAMQUYEN_PARENT.ICOQUAN=p_ITHAMQUYENDONVI_PARENT OR p_ITHAMQUYENDONVI_PARENT=0)
        ORDER BY KN_TONGHOP.ITHAMQUYENDONVI,KN_TONGHOP.ILINHVUC,KN_TONGHOP.ITONGHOP),
        KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.ID_GOP>0  AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) ORDER BY KN_KIENNGHI.ID_GOP),
        TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
              LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
              (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP),
        KIENNGHI AS(
        SELECT COALESCE(KN_KIENNGHI.IKIENNGHI,0) AS IKIENNGHI,KN_KIENNGHI.ID_GOP,KN_KIENNGHI.ITONGHOP_BDN AS KIENNGHI_ID_TONGHOP,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI,
        KN_KIENNGHI.ITONGHOP AS KIENNGHI_ID_TONGHOP_DIAPHUONG,COALESCE(KN_KIENNGHI.ILINHVUC,0) AS ID_LINHVUC_KIENNGHI,
        LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_KIENNGHI,QUOCHOI_COQUAN.CTEN AS TEN_DONVITIEPNHAN_KIENNGHI,
        TBL2.TENDONVITIEPNHAN_GOP,
        COALESCE(KN_KIENNGHI_TRALOI.IUSER,0) AS ID_TRALOI_USER,COALESCE(KN_GIAMSAT.IUSER,0) AS ID_GIAMSAT_USER,
        COALESCE(KN_KIENNGHI_TRALOI.ITRALOI,0) AS ID_TRALOI,COALESCE(KN_GIAMSAT.IGIAMSAT,0) AS ID_GIAMSAT,
        KN_KIENNGHI_TRALOI.CSOVANBAN AS TRALOI_SOVANBAN, KN_KIENNGHI_TRALOI.CTRALOI AS TRALOI_NOIDUNG,
        KN_KIENNGHI_TRALOI.CCOQUANTRALOI AS COQUANTRALOI,
        KN_KIENNGHI_TRALOI.DNGAYBANHANH AS TRALOI_NGAYBANHANH_VANBAN, 
        TRALOI_PHANLOAI.CTEN AS TRALOI_PHANLOAI,COALESCE(TRALOI_PHANLOAI.IPARENT,0) AS ID_PARENT_TRALOI_PHANLOAI,
        TRALOI_PHANLOAI_PARENT.CTEN AS PARENT_TRALOI_PHANLOAI,
        GIAMSAT_PHANLOAI.CTEN AS GIAMSAT_PHANLOAI,COALESCE(GIAMSAT_PHANLOAI.IPARENT,0) AS ID_PARENT_GIAMSAT_PHANLOAI,
        GIAMSAT_PHANLOAI_PARENT.CTEN AS PARENT_GIAMSAT_PHANLOAI,
        THAMQUYEN_KIENNGHI.CTEN AS TEN_DONVI_THAMQUYENKIENNGHI,
        COALESCE(KN_GIAMSAT.IDONGKIENNGHI,-1) AS GIAMSAT_DONGKIENNGHI, 
        COALESCE(KN_GIAMSAT.IDUNGTIENDO,0) AS GIAMSAT_DUNGTIENDO,
				KN_KIENNGHI.ICANHBAO,
				KN_KIENNGHI.INGAYQUYDINH
        FROM KN_KIENNGHI LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
        LEFT JOIN QUOCHOI_COQUAN ON KN_KIENNGHI.IDONVITIEPNHAN=QUOCHOI_COQUAN.ICOQUAN  
        LEFT JOIN QUOCHOI_COQUAN THAMQUYEN_KIENNGHI ON KN_KIENNGHI.ITHAMQUYENDONVI=THAMQUYEN_KIENNGHI.ICOQUAN  
        LEFT JOIN TBL2 ON TBL2.ID_KIENNGHI_PARENT_GOP=KN_KIENNGHI.IKIENNGHI
        LEFT JOIN KN_KIENNGHI_TRALOI ON KN_KIENNGHI.IKIENNGHI=KN_KIENNGHI_TRALOI.IKIENNGHI
        LEFT JOIN KN_GIAMSAT ON KN_KIENNGHI.IKIENNGHI=KN_GIAMSAT.IKIENNGHI
      LEFT JOIN KN_TRALOI_PHANLOAI TRALOI_PHANLOAI ON TRALOI_PHANLOAI.IPHANLOAI=KN_KIENNGHI_TRALOI.IPHANLOAI
      LEFT JOIN KN_TRALOI_PHANLOAI TRALOI_PHANLOAI_PARENT ON TRALOI_PHANLOAI_PARENT.IPHANLOAI=TRALOI_PHANLOAI.IPARENT
      LEFT JOIN KN_TRALOI_PHANLOAI GIAMSAT_PHANLOAI ON GIAMSAT_PHANLOAI.IPHANLOAI=KN_GIAMSAT.IPHANLOAI
      LEFT JOIN KN_TRALOI_PHANLOAI GIAMSAT_PHANLOAI_PARENT ON GIAMSAT_PHANLOAI_PARENT.IPHANLOAI=GIAMSAT_PHANLOAI.IPARENT
        WHERE (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) 
      ),
        TBL4 AS(
        SELECT TBL3.*,KIENNGHI.* FROM TBL3 LEFT JOIN KIENNGHI ON 
        TBL3.ITONGHOP=KIENNGHI.KIENNGHI_ID_TONGHOP OR TBL3.ITONGHOP=KIENNGHI_ID_TONGHOP_DIAPHUONG
        WHERE TBL3.SOKIENNGHI_CHUATRALOI>p_CHUA_TRALOI AND TBL3.SOKIENNGHI_DATRALOI>p_DA_TRALOI
        AND TBL3.ITINHTRANG BETWEEN p_TINHTRANG_FROM AND p_TINHTRANG_TO AND TBL3.SOKIENNGHI_TONGHOP>0
        AND (KIENNGHI.ID_TRALOI=p_TRALOI_KIENNGHI OR p_TRALOI_KIENNGHI=-1)
        AND KIENNGHI.ID_TRALOI>p_DATRALOI_KIENNGHI
        ORDER BY TBL3.ID_THAMQUYEN_DONVI_TONGHOP,TBL3.ITONGHOP,KIENNGHI.ID_LINHVUC_KIENNGHI
        )
        SELECT * FROM 
        ( SELECT k.*,(SELECT COUNT(*) FROM TBL4) AS TOTAL,  ROWNUM r_ FROM( select * from TBL4 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 ) ) WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1)
        ;
      /*WITH TBL1 AS(
        SELECT  KN_TONGHOP.ITONGHOP,KN_TONGHOP.ITINHTRANG,KN_TONGHOP.IUSER AS IUSER_CAPNHAT,
            KN_TONGHOP.ILINHVUC AS ID_LINHVUC_TONGHOP,
            (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_TONGHOP.IDONVITONGHOP) AS TEN_DONVITONGHOP,
            (SELECT ICOQUAN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_TONGHOP.IDONVITONGHOP) AS ID_DONVITONGHOP,
            (SELECT ICOQUAN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_TONGHOP.ITHAMQUYENDONVI) AS ID_THAMQUYEN_DONVI_TONGHOP,
            (SELECT CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_TONGHOP.ITHAMQUYENDONVI) AS TEN_THAMQUYEN_DONVI_TONGHOP,
            (SELECT CTEN FROM LINHVUC_COQUAN WHERE ILINHVUC=KN_TONGHOP.ILINHVUC) AS TEN_LINHVUC_TONGHOP,            
            (SELECT IPARENT FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_TONGHOP.ITHAMQUYENDONVI) AS ID_PARENT_THAMQUYEN_DONVI,
            KN_TONGHOP.CNOIDUNG AS NOIDUNG_TONGHOP, 
            (SELECT COUNT(*) FROM KN_KIENNGHI WHERE KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP OR KN_KIENNGHI.ITONGHOP_BDN=KN_TONGHOP.ITONGHOP) AS SOKIENNGHI_TONGHOP,
            (SELECT COUNT(*) FROM KN_KIENNGHI INNER JOIN KN_KIENNGHI_TRALOI ON KN_KIENNGHI_TRALOI.IKIENNGHI=KN_KIENNGHI.IKIENNGHI
            WHERE KN_KIENNGHI.ITONGHOP=KN_TONGHOP.ITONGHOP OR KN_KIENNGHI.ITONGHOP_BDN=KN_TONGHOP.ITONGHOP) AS SOKIENNGHI_DATRALOI
        FROM KN_TONGHOP INNER JOIN KN_VANBAN ON KN_TONGHOP.ITONGHOP=KN_VANBAN.ITONGHOP                        
        WHERE 
        (KN_VANBAN.CLOAI='tonghop_chuyendonvi_xuly' OR KN_VANBAN.CLOAI='tonghop_chuyenxuly') AND
        KN_TONGHOP.ITINHTRANG>=1 AND
        (p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP) AND 
        (p_ILINHVUC=-1 OR KN_TONGHOP.ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITONGHOP=0 OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) AND 
        (p_ITRUOCKYHOP=-1 OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
        (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)  AND KN_TONGHOP.ITHAMQUYENDONVI!=0 
        AND UPPER(KN_TONGHOP.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
      ),TBL2 AS(SELECT QUOCHOI_COQUAN.CTEN AS TEN_PARENT_THAMQUYEN_DONVI,QUOCHOI_COQUAN.ICOQUAN AS ICOQUAN_PARENT
          FROM QUOCHOI_COQUAN WHERE IPARENT=0),
      TBL3 AS(SELECT KN_VANBAN.DNGAYDUKIENHOANTHANH AS NGAYDUKIENHOANTHANH,
                KN_VANBAN.ITONGHOP AS ITONGHOP_VANBAN,
                KN_VANBAN.DNGAYBANHANH AS NGAYBANHANH_VANBAN
                FROM KN_VANBAN WHERE (KN_VANBAN.CLOAI='tonghop_chuyendonvi_xuly' OR KN_VANBAN.CLOAI='tonghop_chuyenxuly'))
      SELECT TBL1.*,TBL2.*,TBL3.*,(TBL1.SOKIENNGHI_TONGHOP-TBL1.SOKIENNGHI_DATRALOI)
      AS SOKIENNGHI_CHUATRALOI FROM TBL1 LEFT JOIN TBL2 ON TBL1.ID_PARENT_THAMQUYEN_DONVI=TBL2.ICOQUAN_PARENT
                          LEFT JOIN TBL3 ON TBL1.ITONGHOP=TBL3.ITONGHOP_VANBAN
               WHERE p_ITHAMQUYENDONVI_PARENT=0 OR TBL1.ID_PARENT_THAMQUYEN_DONVI=p_ITHAMQUYENDONVI_PARENT;
      */
  END PRC_LIST_TONGHOP_KIENNGHI;
PROCEDURE PRC_LIST_TONGHOP_CHUATRALOI(res out sys_refcursor, p_ILOAI IN NUMBER, p_USER IN NUMBER, p_ITINHTRANG in NUMBER, /* DEFAULT: -1*/
                                                                 p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                                 p_IDONVITONGHOP in NUMBER, /* DEFAULT: 0*/
                                                                 p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                                 p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                                 p_ITHAMQUYENDONVI_PARENT IN NUMBER,
                                                                 p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/																																 p_LISTKYHOP in NVARCHAR2,                                                                 
                                                                 p_CNOIDUNG IN NVARCHAR2,/* DEFAULT: */                                                                 
                                                                p_PAGE IN NUMBER,/* DEFAULT: */
                                                                p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                                 ) AS
    BEGIN
      Open res for
      WITH 
      SOKIENNGHI_TONGHOP as (
          SELECT COUNT(*) AS TONGSOKIENNGHI,KN_TONGHOP.ITONGHOP AS ID_TONGHOP
                FROM KN_TONGHOP
                INNER JOIN KN_KIENNGHI  ON (KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP OR KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP_BDN)
                WHERE KN_KIENNGHI.ID_GOP<=0 GROUP BY KN_TONGHOP.ITONGHOP
      ),
      SOKIENNGHI_TRALOI as (
          SELECT COUNT(*) AS TONGSOKIENNGHI_TRALOI,KN_TONGHOP.ITONGHOP AS ID_TONGHOP
                FROM KN_TONGHOP 
                INNER JOIN KN_KIENNGHI ON (KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP OR KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP_BDN)
                INNER JOIN KN_KIENNGHI_TRALOI ON KN_KIENNGHI.IKIENNGHI=KN_KIENNGHI_TRALOI.IKIENNGHI 
                WHERE KN_KIENNGHI.ID_GOP<=0 GROUP BY KN_TONGHOP.ITONGHOP
      ),
        TBL3 as (SELECT  KN_TONGHOP.ITONGHOP,KN_TONGHOP.IUSER AS IUSER_CAPNHAT,            
            COQUAN_TONGHOP.CTEN AS TEN_DONVITONGHOP,
            KN_TONGHOP.IDONVITONGHOP AS ID_DONVITONGHOP,
            KN_TONGHOP.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI_TONGHOP,
            COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI_TONGHOP,
            LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_TONGHOP,KN_TONGHOP.ILINHVUC AS ID_LINHVUC_TONGHOP,            
            COQUAN_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,
            KN_VANBAN.DNGAYDUKIENHOANTHANH AS NGAYDUKIENHOANTHANH,
            KN_VANBAN.DNGAYBANHANH AS NGAYBANHANH_VANBAN,
            KN_TONGHOP.CNOIDUNG AS NOIDUNG_TONGHOP, 
            COQUAN_THAMQUYEN_PARENT.CTEN AS TEN_PARENT_THAMQUYEN_DONVI,
            COALESCE(SOKIENNGHI_TONGHOP.TONGSOKIENNGHI,0) AS SOKIENNGHI_TONGHOP,
            COALESCE(SOKIENNGHI_TRALOI.TONGSOKIENNGHI_TRALOI,0) AS SOKIENNGHI_DATRALOI,
            (COALESCE(SOKIENNGHI_TONGHOP.TONGSOKIENNGHI,0)-COALESCE(SOKIENNGHI_TRALOI.TONGSOKIENNGHI_TRALOI,0)) AS SOKIENNGHI_CHUATRALOI
        FROM KN_TONGHOP Inner JOIN KN_VANBAN ON KN_TONGHOP.ITONGHOP=KN_VANBAN.ITONGHOP 
        Inner JOIN QUOCHOI_COQUAN COQUAN_TONGHOP ON KN_TONGHOP.IDONVITONGHOP=COQUAN_TONGHOP.ICOQUAN 
        Inner JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON KN_TONGHOP.ITHAMQUYENDONVI=COQUAN_THAMQUYEN.ICOQUAN 
        Inner JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN_PARENT ON COQUAN_THAMQUYEN.IPARENT=COQUAN_THAMQUYEN_PARENT.ICOQUAN 
        LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_TONGHOP.ILINHVUC
        LEFT JOIN SOKIENNGHI_TONGHOP ON SOKIENNGHI_TONGHOP.ID_TONGHOP=KN_TONGHOP.ITONGHOP
        LEFT JOIN SOKIENNGHI_TRALOI ON SOKIENNGHI_TRALOI.ID_TONGHOP=KN_TONGHOP.ITONGHOP
        WHERE 1=1 
        and ( p_USER = 0 or  KN_TONGHOP.IUSER = p_USER or (KN_TONGHOP.itonghop in ( select itonghop from kn_kiennghi where kn_kiennghi.IUSER= p_USER )))
        --SOKIENNGHI_TONGHOP.TONGSOKIENNGHI>0 AND 
        AND (KN_VANBAN.CLOAI='tonghop_chuyendonvi_xuly' OR KN_VANBAN.CLOAI='tonghop_chuyenxuly') 
        --AND (p_IKYHOP=0 OR KN_TONGHOP.IKYHOP=p_IKYHOP)  
        AND (p_ILINHVUC=-1 OR KN_TONGHOP.ILINHVUC=p_ILINHVUC) 
        AND (p_IDONVITONGHOP=0 OR KN_TONGHOP.IDONVITONGHOP=p_IDONVITONGHOP) 
        AND (p_ITRUOCKYHOP=-1 OR KN_TONGHOP.ITRUOCKYHOP=p_ITRUOCKYHOP) 
        AND (p_ITHAMQUYENDONVI=0 OR KN_TONGHOP.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI or  KN_TONGHOP.IDONVITONGHOP=p_ITHAMQUYENDONVI)  
        AND KN_TONGHOP.ITHAMQUYENDONVI!=0 
        --AND ( (UPPER(KN_TONGHOP.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%') OR () )
        AND (COQUAN_THAMQUYEN_PARENT.ICOQUAN=p_ITHAMQUYENDONVI_PARENT OR p_ITHAMQUYENDONVI_PARENT=0)
        ORDER BY KN_TONGHOP.ITHAMQUYENDONVI,KN_TONGHOP.ILINHVUC,KN_TONGHOP.ITONGHOP),
        KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.ID_GOP>0  ORDER BY KN_KIENNGHI.ID_GOP),
      TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
              LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
              (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP),
       KIENNGHI AS(
        SELECT COALESCE(KN_KIENNGHI.IKIENNGHI,0) AS IKIENNGHI,KN_KIENNGHI.ID_GOP,KN_KIENNGHI.ITONGHOP_BDN AS KIENNGHI_ID_TONGHOP,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI , KN_KIENNGHI.ITINHTRANG  , 
                                KN_KIENNGHI_TRALOI.ITRALOI AS ITRALOI,COALESCE(KN_KIENNGHI_TRALOI.ITRALOI,0) AS ID_TRALOI,
        KN_KIENNGHI.ITONGHOP AS KIENNGHI_ID_TONGHOP_DIAPHUONG,COALESCE(KN_KIENNGHI.ILINHVUC,0) AS ID_LINHVUC_KIENNGHI,
        LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_KIENNGHI,QUOCHOI_COQUAN.CTEN AS TEN_DONVITIEPNHAN_KIENNGHI,
        TBL2.TENDONVITIEPNHAN_GOP, KN_KIENNGHI.INGAYQUYDINH, KN_KIENNGHI.ICANHBAO,
        TRALOI_PHANLOAI.CTEN AS TRALOI_PHANLOAI, TRALOI_PHANLOAI_PARENT.CTEN AS PARENT_TRALOI_PHANLOAI,
        KN_KIENNGHI_TRALOI.CSOVANBAN AS TRALOI_SOVANBAN, KN_KIENNGHI_TRALOI.CTRALOI AS TRALOI_NOIDUNG
        FROM KN_KIENNGHI LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
        LEFT JOIN QUOCHOI_COQUAN ON KN_KIENNGHI.IDONVITIEPNHAN=QUOCHOI_COQUAN.ICOQUAN  
        LEFT JOIN TBL2 ON TBL2.ID_KIENNGHI_PARENT_GOP=KN_KIENNGHI.IKIENNGHI
        LEFT JOIN KN_KIENNGHI_TRALOI on KN_KIENNGHI_TRALOI.IKIENNGHI = KN_KIENNGHI.IKIENNGHI
        LEFT JOIN KN_TRALOI_PHANLOAI TRALOI_PHANLOAI ON TRALOI_PHANLOAI.IPHANLOAI=KN_KIENNGHI_TRALOI.IPHANLOAI
        LEFT JOIN KN_TRALOI_PHANLOAI TRALOI_PHANLOAI_PARENT ON TRALOI_PHANLOAI_PARENT.IPHANLOAI=TRALOI_PHANLOAI.IPARENT
        WHERE (KN_KIENNGHI.IKYHOP IN (select regexp_substr(p_LISTKYHOP,'[^,]+', 1, level)
					from dual
					connect BY regexp_substr(p_LISTKYHOP, '[^,]+', 1, level)
					is not null) OR p_LISTKYHOP = '0')
        --AND KN_KIENNGHI.ITONGHOP_BDN!=0 
        --AND (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)
      ),
        TBL4 AS( SELECT TBL3.*,KIENNGHI.* FROM TBL3 LEFT JOIN KIENNGHI ON 
        TBL3.ITONGHOP=KIENNGHI.KIENNGHI_ID_TONGHOP OR TBL3.ITONGHOP=KIENNGHI.KIENNGHI_ID_TONGHOP_DIAPHUONG
        WHERE (KIENNGHI.ITINHTRANG = p_ILOAI or (p_ILOAI = -1 and (KIENNGHI.ITINHTRANG = 4 or KIENNGHI.ITINHTRANG = 5 or KIENNGHI.ITINHTRANG = 6 or KIENNGHI.ITINHTRANG = 8)))
        	AND ( (UPPER(TBL3.NOIDUNG_TONGHOP) LIKE '%' || UPPER(p_CNOIDUNG) || '%') OR (UPPER(KIENNGHI.NOIDUNG_KIENNGHI) LIKE '%' || UPPER(p_CNOIDUNG) || '%'))
        	--AND KIENNGHI.ID_TRALOI > 0
        ORDER BY TBL3.ID_THAMQUYEN_DONVI_TONGHOP,TBL3.ITONGHOP,KIENNGHI.ID_LINHVUC_KIENNGHI
        )
        SELECT * FROM 
        ( SELECT k.*,(SELECT COUNT(*) FROM TBL4) AS TOTAL,  ROWNUM r_ FROM( select * from TBL4 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 ) ) WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1)
        ;

  END PRC_LIST_TONGHOP_CHUATRALOI;
  /* KIENNGHI CO DANH GIA, TRALOI*/
  PROCEDURE PRC_LIST_KN_TRALOI_DANHGIA(res out sys_refcursor, p_IDKIENNGHI in NUMBER, /* KIENNGHI DUOC TONG HOP O BDN DEFAULT: 0*/
                                                              p_ITONGHOP_BDN in NUMBER, /* KIENNGHI DUOC TONG HOP O BDN DEFAULT: 0*/
                                                              p_ITONGHOP in NUMBER, /* KIENNGHI DIAPHUONG CHUYEN DIA PHUONG DEFAULT: 0*/
                                                                 p_ILINHVUC IN NUMBER, /* DEFAULT: -1*/
                                                                 p_IDONVITIEPNHAN in NUMBER, /* DEFAULT: 0*/
                                                                 p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                                 p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                                 p_ITHAMQUYENDONVI_PARENT IN NUMBER,/* DEFAULT: 0*/
                                                                 p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                                 p_CNOIDUNG IN NVARCHAR2,
                                                                 p_KETQUA_DANHGIA IN NUMBER,
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER/* DEFAULT: */  
                                                                 ) AS
    BEGIN
      Open res for
      WITH TBL1 AS(
      SELECT
        KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYENDONVI,KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
        COQUAN_TIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYENDONVI,
        KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.ID_GOP AS ID_GOP,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI,  
        COQUAN_THAMQUYEN.IPARENT AS ID_THAMQUYENDONVI_PARENT,
        KN_KIENNGHI_TRALOI.CSOVANBAN AS TRALOI_SOVANBAN, KN_KIENNGHI_TRALOI.CTRALOI AS TRALOI_NOIDUNG,
        KN_KIENNGHI_TRALOI.DNGAYBANHANH AS TRALOI_NGAYBANHANH_VANBAN, 
        KN_KIENNGHI_TRALOI.CCOQUANTRALOI AS COQUANTRALOI,
        COALESCE(KN_KIENNGHI_TRALOI.ITINHTRANG,0) AS TRALOI_TINHTRANG,
        LINHVUC_COQUAN.CTEN AS TEN_LINHVUC_KIENNGHI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC_KIENNGHI,
        TRALOI_PHANLOAI.CTEN AS TRALOI_PHANLOAI,COALESCE(TRALOI_PHANLOAI.IPARENT,0) AS ID_PARENT_TRALOI_PHANLOAI,
        TRALOI_PHANLOAI_PARENT.CTEN AS PARENT_TRALOI_PHANLOAI,
        GIAMSAT_PHANLOAI.CTEN AS GIAMSAT_PHANLOAI,COALESCE(GIAMSAT_PHANLOAI.IPARENT,0) AS ID_PARENT_GIAMSAT_PHANLOAI,
        GIAMSAT_PHANLOAI_PARENT.CTEN AS PARENT_GIAMSAT_PHANLOAI,
        COALESCE(KN_GIAMSAT.IDONGKIENNGHI,-1) AS GIAMSAT_DONGKIENNGHI, 
        COALESCE(KN_GIAMSAT.IDUNGTIENDO,0) AS GIAMSAT_DUNGTIENDO
      FROM KN_KIENNGHI_TRALOI 
      INNER JOIN KN_KIENNGHI ON KN_KIENNGHI_TRALOI.IKIENNGHI=KN_KIENNGHI.IKIENNGHI  
      left JOIN KN_TONGHOP ON KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP_BDN
			left JOIN KN_TONGHOP ON KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP
      LEFT JOIN QUOCHOI_COQUAN COQUAN_TIEPNHAN ON COQUAN_TIEPNHAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN
      LEFT JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON COQUAN_THAMQUYEN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
      LEFT JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN_PARENT ON COQUAN_THAMQUYEN_PARENT.ICOQUAN=COQUAN_THAMQUYEN.IPARENT
      LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC      
      LEFT JOIN KN_GIAMSAT ON KN_KIENNGHI.IKIENNGHI=KN_GIAMSAT.IKIENNGHI
      LEFT JOIN KN_TRALOI_PHANLOAI TRALOI_PHANLOAI ON TRALOI_PHANLOAI.IPHANLOAI=KN_KIENNGHI_TRALOI.IPHANLOAI
      LEFT JOIN KN_TRALOI_PHANLOAI TRALOI_PHANLOAI_PARENT ON TRALOI_PHANLOAI_PARENT.IPHANLOAI=TRALOI_PHANLOAI.IPARENT
      LEFT JOIN KN_TRALOI_PHANLOAI GIAMSAT_PHANLOAI ON GIAMSAT_PHANLOAI.IPHANLOAI=KN_KIENNGHI_TRALOI.IPHANLOAI
      LEFT JOIN KN_TRALOI_PHANLOAI GIAMSAT_PHANLOAI_PARENT ON GIAMSAT_PHANLOAI_PARENT.IPHANLOAI=GIAMSAT_PHANLOAI.IPARENT
      WHERE (KN_KIENNGHI.ITONGHOP!=0 OR KN_KIENNGHI.ITONGHOP_BDN!=0) AND
       KN_KIENNGHI_TRALOI.ITINHTRANG IN(1,2) AND 
       (p_ITHAMQUYENDONVI_PARENT=0 OR COQUAN_THAMQUYEN_PARENT.ICOQUAN=p_ITHAMQUYENDONVI_PARENT) AND
       (p_IDKIENNGHI=0 OR KN_KIENNGHI.IKIENNGHI=p_IDKIENNGHI) AND 
       (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND 
       (p_ITONGHOP_BDN=0 OR KN_KIENNGHI.ITONGHOP_BDN=p_ITONGHOP_BDN) AND 
       (p_ITONGHOP=0 OR KN_KIENNGHI.ITONGHOP=p_ITONGHOP) AND
       (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC=p_ILINHVUC) AND 
       (p_IDONVITIEPNHAN=0 OR KN_KIENNGHI.IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
       (p_ITRUOCKYHOP=-1 OR KN_KIENNGHI.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
       (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)   
       AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
      ORDER BY KN_KIENNGHI.ID_GOP),
    KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.ID_GOP>0 AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) ORDER BY KN_KIENNGHI.ID_GOP),
        TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
            LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
            (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP             
            ),
    TBL3 as( select TBL1.*,TBL2.*
    from TBL1 LEFT JOIN TBL2 on TBL1.ID_KIENNGHI=TBL2.ID_KIENNGHI_PARENT_GOP
          WHERE p_KETQUA_DANHGIA=-1 OR TBL1.GIAMSAT_DONGKIENNGHI=p_KETQUA_DANHGIA
          ORDER BY 
         TBL1.ID_THAMQUYENDONVI_PARENT,TBL1.ID_THAMQUYENDONVI,TBL1.ID_LINHVUC_KIENNGHI)
    SELECT * FROM 
        ( SELECT k.*,(SELECT COUNT(*) FROM TBL3) AS TOTAL,  ROWNUM r_ FROM( select * from TBL3 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 ) ) WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
      /*
      WITH TBL1 AS(
      select 
        KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYENDONVI,KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
        (SELECT QUOCHOI_COQUAN.CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TEN_DONVITIEPNHAN,
        (SELECT QUOCHOI_COQUAN.CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS TEN_THAMQUYENDONVI,
        KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.ID_GOP AS ID_GOP,KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI,  
        (SELECT QUOCHOI_COQUAN.IPARENT FROM QUOCHOI_COQUAN WHERE ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI) AS ID_THAMQUYENDONVI_PARENT,
        --(select QUOCHOI_COQUAN.IPARENT from  QUOCHOI_COQUAN  start with QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
        --  connect by prior QUOCHOI_COQUAN.ICOQUAN = QUOCHOI_COQUAN.IPARENT) AS ID_THAMQUYENDONVI_PARENT,
        --(select  (select CTEN FROM QUOCHOI_COQUAN WHERE ICOQUAN=COQUAN.IPARENT) AS TENDONVI from  QUOCHOI_COQUAN COQUAN start with   COQUAN.ICOQUAN=KN_KIENNGHI.ITHAMQUYENDONVI
        --  connect by   prior COQUAN.icoquan = COQUAN.IPARENT) AS TEN_THAMQUYENDONVI_PARENT,
        KN_KIENNGHI_TRALOI.CSOVANBAN AS TRALOI_SOVANBAN, KN_KIENNGHI_TRALOI.CTRALOI AS TRALOI_NOIDUNG,
        KN_KIENNGHI_TRALOI.DNGAYBANHANH AS TRALOI_NGAYBANHANH_VANBAN, 
        COALESCE(KN_KIENNGHI_TRALOI.ITINHTRANG,0) AS TRALOI_TINHTRANG,
        (SELECT CTEN FROM LINHVUC_COQUAN WHERE ILINHVUC=KN_KIENNGHI.ILINHVUC) AS TEN_LINHVUC_KIENNGHI,
        KN_KIENNGHI.ILINHVUC AS ID_LINHVUC_KIENNGHI,
        (SELECT CTEN FROM KN_TRALOI_PHANLOAI WHERE IPHANLOAI=KN_KIENNGHI_TRALOI.IPHANLOAI) AS TRALOI_PHANLOAI,
        COALESCE((SELECT IPARENT FROM KN_TRALOI_PHANLOAI WHERE IPHANLOAI=KN_KIENNGHI_TRALOI.IPHANLOAI),0) AS ID_PARENT_TRALOI_PHANLOAI,
        (SELECT CTEN FROM KN_TRALOI_PHANLOAI WHERE IPHANLOAI=KN_GIAMSAT.IPHANLOAI) AS GIAMSAT_PHANLOAI,
        COALESCE((SELECT IPARENT FROM KN_TRALOI_PHANLOAI WHERE IPHANLOAI=KN_GIAMSAT.IPHANLOAI),0) AS ID_PARENT_GIAMSAT_PHANLOAI,
        COALESCE(KN_GIAMSAT.IDONGKIENNGHI,-1) AS GIAMSAT_DONGKIENNGHI, 
        COALESCE(KN_GIAMSAT.IDUNGTIENDO,0) AS GIAMSAT_DUNGTIENDO
      FROM KN_KIENNGHI_TRALOI 
      INNER JOIN KN_KIENNGHI ON KN_KIENNGHI_TRALOI.IKIENNGHI=KN_KIENNGHI.IKIENNGHI  
      INNER JOIN KN_TONGHOP ON KN_TONGHOP.ITONGHOP=KN_KIENNGHI.ITONGHOP_BDN
      --LEFT JOIN KN_GIAMSAT ON KN_KIENNGHI_TRALOI.ITRALOI=KN_GIAMSAT.IGIAMSAT
      LEFT JOIN KN_GIAMSAT ON KN_KIENNGHI.IKIENNGHI=KN_GIAMSAT.IKIENNGHI
      WHERE (KN_KIENNGHI.ITONGHOP!=0 OR KN_KIENNGHI.ITONGHOP_BDN!=0) AND
       KN_KIENNGHI_TRALOI.ITINHTRANG IN(1,2) AND
       (p_IDKIENNGHI=0 OR KN_KIENNGHI.IKIENNGHI=p_IDKIENNGHI) AND 
       (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) AND 
        (p_ITONGHOP_BDN=0 OR KN_KIENNGHI.ITONGHOP_BDN=p_ITONGHOP_BDN) AND 
        (p_ITONGHOP=0 OR KN_KIENNGHI.ITONGHOP=p_ITONGHOP) AND
        (p_ILINHVUC=-1 OR KN_KIENNGHI.ILINHVUC=p_ILINHVUC) AND 
        (p_IDONVITIEPNHAN=0 OR KN_KIENNGHI.IDONVITIEPNHAN=p_IDONVITIEPNHAN) AND 
        (p_ITRUOCKYHOP=-1 OR KN_KIENNGHI.ITRUOCKYHOP=p_ITRUOCKYHOP) AND 
        (p_ITHAMQUYENDONVI=0 OR KN_KIENNGHI.ITHAMQUYENDONVI=p_ITHAMQUYENDONVI)   
        AND UPPER(KN_KIENNGHI.CNOIDUNG) LIKE '%' || UPPER(p_CNOIDUNG) || '%'
      ORDER BY KN_KIENNGHI.ID_GOP),
    TBL2 as(
      select  KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_CHILD_GOP,
      (SELECT CTEN FROM QUOCHOI_COQUAN WHERE QUOCHOI_COQUAN.ICOQUAN=KN_KIENNGHI.IDONVITIEPNHAN) AS TENDONVITIEPNHAN_GOP
      FROM KN_KIENNGHI WHERE ID_GOP>0 start with ID_GOP=-1 CONNECT BY PRIOR IKIENNGHI=ID_GOP      
    ),
    TBL3 AS (SELECT IPHANLOAI,CTEN AS TEN_PHANLOAI_PARENT,IVITRI FROM KN_TRALOI_PHANLOAI)
    select TBL1.*,TBL2.*,
    (SELECT TEN_PHANLOAI_PARENT FROM TBL3 WHERE TBL3.IPHANLOAI=TBL1.ID_PARENT_TRALOI_PHANLOAI) AS PARENT_TRALOI_PHANLOAI,
    (SELECT TEN_PHANLOAI_PARENT FROM TBL3 WHERE TBL3.IPHANLOAI=TBL1.ID_PARENT_GIAMSAT_PHANLOAI) AS PARENT_GIAMSAT_PHANLOAI
    from TBL1 LEFT JOIN TBL2 on TBL1.ID_KIENNGHI=TBL2.ID_KIENNGHI_CHILD_GOP
              LEFT JOIN TBL3 ON TBL1.ID_PARENT_TRALOI_PHANLOAI=TBL3.IPHANLOAI
    WHERE p_ITHAMQUYENDONVI_PARENT=0 OR TBL1.ID_THAMQUYENDONVI_PARENT=p_ITHAMQUYENDONVI_PARENT;
    */
  END PRC_LIST_KN_TRALOI_DANHGIA;


 PROCEDURE PRC_KIENNGHI_MOICAPNHATTEST(res out sys_refcursor, p_IUSER in NUMBER, /* DEFAULT: -1*/
                                                               p_LSTLINHVUC IN VARCHAR2, /* DEFAULT: -1*/
                                                               p_IDONVITIEPNHAN in NUMBER, /* DEFAULT: 0*/
                                                               p_LSTNGUONKN IN VARCHAR2, /* DEFAULT: 0*/
                                                               p_IKYHOP in NUMBER, /* DEFAULT: 0*/
                                                               p_ITRUOCKYHOP IN NUMBER, /* DEFAULT: -1*/
                                                               p_ITHAMQUYENDONVI_PARENT in NUMBER,/* DEFAULT: 0*/
                                                               p_ITHAMQUYENDONVI in NUMBER,/* DEFAULT: 0*/
                                                               p_CNOIDUNG IN NVARCHAR2,/* DEFAULT: */
                                                               p_LISTKYHOP in NVARCHAR2,
                                                               p_MAKIENNGHI IN NUMBER,
                                                               p_TUNGAY IN DATE,
                                                               p_DENNGAY IN DATE,
                                                               p_PAGE IN NUMBER,/* DEFAULT: */
                                                               p_PAGE_SIZE IN NUMBER/* DEFAULT: */
                                                               ) AS
  BEGIN
    Open res for
    WITH TBL1 AS
    ( SELECT  KN_KIENNGHI.IKIENNGHI AS ID_KIENNGHI, KN_KIENNGHI.ID_GOP, KN_KIENNGHI.IUSER AS ID_USER_CAPNHAT,
              KN_KIENNGHI.IKIENNGHI_TRUNG AS ID_KIENNGHI_TRUNG, KN_KIENNGHI.ITONGHOP AS ID_KIENNGHI_TONGHOP,
              KN_KIENNGHI.ITONGHOP_BDN AS ID_KIENNGHI_TONGHOP_BDN, KN_KIENNGHI.IDONVITIEPNHAN AS ID_DONVITIEPNHAN,
              0 AS SOLUONG_KIENNGHI_GOP,
              COQUAN_TIEPNHAN.CTEN AS TEN_DONVITIEPNHAN,
              KN_KIENNGHI.ITHAMQUYENDONVI AS ID_THAMQUYEN_DONVI,KN_KIENNGHI.ILINHVUC AS ID_LINHVUC,ITINHTRANG,
              COQUAN_THAMQUYEN.IPARENT AS ID_PARENT_THAMQUYEN_DONVI,USERS.IDONVI AS ID_DONVI_CAPNHAT,
              COQUAN_THAMQUYEN.CTEN AS TEN_THAMQUYEN_DONVI,LINHVUC_COQUAN.CTEN AS TEN_LINHVUC,              
              KN_KIENNGHI.CNOIDUNG AS NOIDUNG_KIENNGHI, KN_KIENNGHI.IKYHOP
      FROM KN_KIENNGHI 
      LEFT JOIN QUOCHOI_COQUAN COQUAN_TIEPNHAN ON KN_KIENNGHI.IDONVITIEPNHAN=COQUAN_TIEPNHAN.ICOQUAN
      LEFT JOIN QUOCHOI_COQUAN COQUAN_THAMQUYEN ON KN_KIENNGHI.ITHAMQUYENDONVI=COQUAN_THAMQUYEN.ICOQUAN
      LEFT JOIN USERS ON USERS.IUSER=KN_KIENNGHI.IUSER
      LEFT JOIN LINHVUC_COQUAN ON LINHVUC_COQUAN.ILINHVUC=KN_KIENNGHI.ILINHVUC
      WHERE 
        (p_LSTNGUONKN IS NULL OR KN_KIENNGHI.INGUONKIENNGHI IN  (select regexp_substr(p_LSTNGUONKN,'[^,]+', 1, level) from dual connect BY regexp_substr(p_LSTNGUONKN, '[^,]+', 1, level) is not null)) 

        ),
        KN_GOP AS (SELECT DISTINCT KN_KIENNGHI.ID_GOP AS ID_KIENNGHI_PARENT_GOP, QUOCHOI_COQUAN.CTEN AS TENCOQUAN FROM 
                KN_KIENNGHI LEFT JOIN QUOCHOI_COQUAN ON QUOCHOI_COQUAN.ICOQUAN =KN_KIENNGHI.IDONVITIEPNHAN
                WHERE KN_KIENNGHI.IDELETE=0 AND KN_KIENNGHI.ID_GOP>0 AND (p_IKYHOP=0 OR KN_KIENNGHI.IKYHOP=p_IKYHOP) ORDER BY KN_KIENNGHI.ID_GOP),
        TBL2 as( select  KN_GOP.ID_KIENNGHI_PARENT_GOP AS ID_KIENNGHI_PARENT_GOP,
            LISTAGG( convert(KN_GOP.TENCOQUAN, 'UTF8', 'AL32UTF8'), ', ') WITHIN GROUP 
            (ORDER BY KN_GOP.ID_KIENNGHI_PARENT_GOP) TENDONVITIEPNHAN_GOP FROM KN_GOP GROUP BY KN_GOP.ID_KIENNGHI_PARENT_GOP             
            ),
        TBL3 AS(
        SELECT * FROM TBL1 LEFT JOIN TBL2 ON TBL1.ID_KIENNGHI=TBL2.ID_KIENNGHI_PARENT_GOP
        --WHERE (TBL1.ITINHTRANG=0 OR (TBL1.ITINHTRANG=0 AND (p_IUSER=0 OR TBL1.ID_USER_CAPNHAT=p_IUSER) AND TBL1.ID_DONVI_CAPNHAT=4))
        WHERE (TBL1.ITINHTRANG=0 OR (TBL1.ITINHTRANG=0 AND (p_IUSER=0 OR TBL1.ID_USER_CAPNHAT=p_IUSER) ))
        ORDER BY TBL1.ID_THAMQUYEN_DONVI,TBL1.ID_LINHVUC,TBL1.ID_KIENNGHI)
        SELECT * FROM 
        (
            SELECT k.*,(SELECT COUNT(*) FROM TBL3) AS TOTAL, 
            ROWNUM r_ FROM( select * from TBL3 ) k
              WHERE ROWNUM < ((p_PAGE * p_PAGE_SIZE) + 1 )
        ) 
        WHERE r_>=    (((p_PAGE-1) * p_PAGE_SIZE) + 1);
  END PRC_KIENNGHI_MOICAPNHATTEST;

END PKG_KIENNGHI_CUTRI;

